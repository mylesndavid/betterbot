<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BetterBot</title>
<style>
  :root {
    --bg: #111118;
    --surface: #1a1a24;
    --surface2: #222230;
    --border: #2a2a3a;
    --border-subtle: #1e1e2e;
    --text: #e0e0e8;
    --text-dim: #8888aa;
    --text-muted: #555566;
    --accent: #e94560;
    --accent-hover: #c73e54;
    --accent-bg: #e9456015;
    --green: #52b788;
    --green-bg: #1b4332;
    --green-dim: #2d6b4a;
    --purple: #b388ff;
    --purple-bg: #2d1b4e;
    --blue: #6699cc;
    --blue-bg: #0f3460;
    --sidebar-w: 56px;
    --topbar-h: 48px;
    --bottombar-h: 32px;
    --mono: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    --sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --radius: 8px;
    --radius-sm: 4px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
  }

  /* ═══════ APP GRID ═══════ */
  .app {
    display: grid;
    grid-template-columns: var(--sidebar-w) 1fr;
    grid-template-rows: var(--topbar-h) 1fr var(--bottombar-h);
    height: 100vh;
  }

  /* ═══════ SIDEBAR ═══════ */
  .sidebar {
    grid-row: 1 / -1;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 10;
  }
  .sidebar-logo {
    height: var(--topbar-h);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 800;
    color: var(--accent);
    letter-spacing: 1px;
    cursor: default;
  }
  .sidebar-nav {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding-top: 8px;
    width: 100%;
  }
  .nav-item {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 44px;
    cursor: pointer;
    border-left: 3px solid transparent;
    transition: all .15s;
    position: relative;
  }
  .nav-item:hover { background: var(--surface2); }
  .nav-item.active {
    border-left-color: var(--accent);
    background: var(--accent-bg);
  }
  .nav-item svg { width: 20px; height: 20px; fill: var(--text-dim); transition: fill .15s; }
  .nav-item.active svg { fill: var(--accent); }
  .nav-item:hover svg { fill: var(--text); }
  .nav-item .tooltip {
    position: absolute;
    left: calc(var(--sidebar-w) + 4px);
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 4px 10px;
    border-radius: var(--radius-sm);
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity .15s;
    z-index: 20;
  }
  .nav-item:hover .tooltip { opacity: 1; }

  /* ═══════ TOP BAR ═══════ */
  .topbar {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
  }
  .topbar-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
  }
  .topbar-badges {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .status-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--text-dim);
    background: var(--surface2);
    padding: 4px 10px;
    border-radius: 12px;
    border: 1px solid var(--border);
  }
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-muted);
  }
  .status-dot.on { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .status-dot.off { background: var(--accent); }

  /* ═══════ CONTENT ═══════ */
  .content {
    overflow: hidden;
    position: relative;
  }
  .view {
    display: none;
    position: absolute;
    inset: 0;
    overflow: hidden;
  }
  .view.active { display: flex; flex-direction: column; }

  /* ═══════ BOTTOM BAR ═══════ */
  .bottombar {
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    font-size: 11px;
    font-family: var(--mono);
    color: var(--text-dim);
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  .bottombar-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green);
    margin-right: 8px;
    flex-shrink: 0;
  }

  /* ═══════ SHARED: BUTTONS ═══════ */
  .btn {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 7px 16px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    font-family: var(--sans);
    transition: background .15s;
    white-space: nowrap;
  }
  .btn:hover { background: var(--accent-hover); }
  .btn.secondary { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); }
  .btn.secondary:hover { background: var(--border); color: var(--text); }
  .btn.danger { background: #8b0000; }
  .btn.danger:hover { background: #a00; }
  .btn.sm { padding: 4px 10px; font-size: 12px; }

  /* ═══════ SHARED: FORMS ═══════ */
  input, select, textarea {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 7px 10px;
    border-radius: var(--radius-sm);
    font-size: 13px;
    font-family: var(--sans);
    outline: none;
    transition: border-color .15s;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--accent); }
  input[type="text"], input[type="number"], input[type="password"] { flex: 1; }
  select { min-width: 100px; }

  /* ═══════ SHARED: BADGES ═══════ */
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
  }
  .badge.ok { background: var(--green-bg); color: var(--green); }
  .badge.no { background: #3d0000; color: var(--accent); }

  /* ═══════ SHARED: TOGGLE ═══════ */
  .toggle { position: relative; width: 40px; height: 22px; cursor: pointer; flex-shrink: 0; }
  .toggle input { display: none; }
  .toggle .slider {
    position: absolute; inset: 0; background: var(--surface2); border-radius: 11px;
    border: 1px solid var(--border); transition: .2s;
  }
  .toggle .slider::before {
    content: ''; position: absolute; width: 16px; height: 16px; left: 2px; top: 2px;
    background: var(--text-dim); border-radius: 50%; transition: .2s;
  }
  .toggle input:checked + .slider { background: var(--green-bg); border-color: var(--green-dim); }
  .toggle input:checked + .slider::before { transform: translateX(18px); background: var(--green); }

  /* ═══════ SHARED: TOAST ═══════ */
  .toast {
    position: fixed; bottom: 48px; right: 24px;
    background: var(--green-bg); color: var(--green); border: 1px solid var(--green-dim);
    padding: 10px 20px; border-radius: var(--radius);
    font-size: 13px; font-weight: 600;
    opacity: 0; transition: opacity .3s; pointer-events: none; z-index: 100;
  }
  .toast.show { opacity: 1; }

  /* ═══════ SHARED: SPINNER ═══════ */
  .spinner::after {
    content: ''; display: inline-block; width: 12px; height: 12px;
    border: 2px solid var(--text-muted); border-top-color: var(--accent);
    border-radius: 50%; animation: spin .6s linear infinite; margin-left: 8px; vertical-align: middle;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ═══════ SHARED: SCROLLBAR ═══════ */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

  /* ═══════════════════════════════════════
     VIEW: SESSIONS (master-detail split)
     ═══════════════════════════════════════ */
  .sessions-split {
    display: grid;
    grid-template-columns: 300px 1fr;
    flex: 1;
    overflow: hidden;
  }
  .session-list-pane {
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .session-search {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .session-search input {
    width: 100%;
    padding: 7px 10px 7px 28px;
    background: var(--bg) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='%23555566' viewBox='0 0 24 24'%3E%3Cpath d='M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E") 8px center no-repeat;
  }
  .session-filters {
    display: flex;
    gap: 4px;
  }
  .filter-pill {
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
    transition: all .15s;
  }
  .filter-pill:hover { border-color: var(--text-dim); color: var(--text); }
  .filter-pill.active { background: var(--accent-bg); border-color: var(--accent); color: var(--accent); }
  .session-items {
    flex: 1;
    overflow-y: auto;
  }
  .session-item {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border-subtle);
    cursor: pointer;
    transition: background .1s;
  }
  .session-item:hover { background: var(--surface2); }
  .session-item.active { background: var(--accent-bg); border-left: 3px solid var(--accent); }
  .session-item-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 3px;
  }
  .session-item-id {
    font-family: var(--mono);
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
  }
  .session-item-time {
    font-size: 11px;
    color: var(--text-muted);
    margin-left: auto;
  }
  .session-item-preview {
    font-size: 12px;
    color: var(--text-dim);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 3px;
  }
  .session-item-stats {
    font-size: 11px;
    color: var(--text-muted);
    display: flex;
    gap: 8px;
  }
  .session-item-cost {
    font-size: 11px;
    font-family: var(--mono);
    color: var(--accent);
    font-weight: 600;
    margin-left: auto;
  }
  .session-item-type {
    font-size: 10px;
    font-weight: 600;
    padding: 1px 6px;
    border-radius: 8px;
    text-transform: uppercase;
  }
  .type-chat { background: var(--blue-bg); color: var(--blue); }
  .type-heartbeat { background: var(--green-bg); color: var(--green); }
  .type-cron { background: var(--purple-bg); color: var(--purple); }

  /* Session detail (trace) */
  .session-detail-pane {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .session-detail-empty {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    font-size: 14px;
  }
  .session-detail-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
    background: var(--surface);
    position: sticky;
    top: 0;
    z-index: 5;
  }
  .session-detail-id {
    font-family: var(--mono);
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
  }
  .session-detail-stats {
    font-size: 12px;
    color: var(--text-dim);
    display: flex;
    gap: 12px;
  }
  .session-detail-actions {
    margin-left: auto;
    display: flex;
    gap: 6px;
  }
  .session-trace {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
  }

  /* Trace message blocks */
  .trace-msg { margin: 4px 0; border-radius: var(--radius-sm); }
  .trace-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    min-height: 32px;
  }
  .trace-role {
    font-size: 10px; text-transform: uppercase; font-weight: 700; letter-spacing: .5px;
    padding: 2px 8px; border-radius: var(--radius-sm); flex-shrink: 0;
  }
  .trace-role.user { background: var(--blue-bg); color: var(--blue); }
  .trace-role.assistant { background: var(--purple-bg); color: var(--purple); }
  .trace-role.tool { background: var(--green-bg); color: var(--green); }
  .trace-role.system { background: var(--surface2); color: var(--text-muted); }
  .trace-chars { font-size: 11px; color: var(--text-muted); flex-shrink: 0; }
  .trace-preview {
    font-size: 12px; color: var(--text-dim); white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis; flex: 1; min-width: 0;
  }
  .trace-expand {
    font-size: 11px; color: var(--accent); cursor: pointer; flex-shrink: 0;
    background: none; border: 1px solid var(--accent-bg); border-radius: var(--radius-sm);
    padding: 2px 8px; transition: all .15s; font-family: var(--sans);
  }
  .trace-expand:hover { background: var(--accent-bg); border-color: var(--accent); }
  .trace-body {
    display: none; padding: 10px 12px; margin: 0 12px 8px; background: var(--bg);
    border-radius: var(--radius-sm); font-family: var(--mono); font-size: 12px;
    white-space: pre-wrap; word-break: break-word; max-height: 400px; overflow-y: auto;
    line-height: 1.6; border: 1px solid var(--border-subtle);
  }
  .trace-body.show { display: block; }

  /* Tool call cards */
  .trace-tool {
    margin: 4px 0; border-left: 3px solid var(--accent);
    background: var(--surface); border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  }
  .trace-tool .trace-header { padding: 8px 12px; cursor: pointer; }
  .trace-tool .trace-header:hover { background: var(--surface2); }
  .trace-tool-name {
    color: var(--accent); font-weight: 600; font-size: 13px; font-family: var(--mono);
  }
  .trace-tool-args {
    font-size: 11px; color: var(--text-dim); margin-left: 8px;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; min-width: 0;
  }
  .trace-tool-id { font-size: 10px; color: var(--text-muted); flex-shrink: 0; font-family: var(--mono); }

  /* Tool result cards */
  .trace-result {
    margin: 4px 0 4px 16px; border-left: 3px solid var(--green);
    background: #0f2820; border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  }
  .trace-result .trace-header { padding: 6px 12px; cursor: pointer; }
  .trace-result .trace-header:hover { background: #1a3025; }
  .trace-result-label { color: var(--green); font-size: 11px; font-weight: 600; }

  /* Audit metadata block */
  .trace-audit {
    margin: 8px 0;
    padding: 10px 14px;
    background: var(--surface);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    font-size: 12px;
  }
  .trace-audit-title {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .5px;
    color: var(--text-dim);
    margin-bottom: 6px;
  }
  .trace-audit-row {
    display: flex;
    gap: 8px;
    margin-bottom: 2px;
  }
  .trace-audit-label { color: var(--text-muted); min-width: 80px; }
  .trace-audit-value { color: var(--text); }

  /* ═══════════════════════════════════════
     VIEW: CHAT
     ═══════════════════════════════════════ */
  .chat-view { display: none; flex-direction: column; }
  .chat-view.active { display: flex; }
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .msg {
    max-width: 75%;
    padding: 10px 14px;
    border-radius: 12px;
    font-size: 14px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .msg.user {
    align-self: flex-end;
    background: var(--blue-bg);
    border-bottom-right-radius: 4px;
  }
  .msg.assistant {
    align-self: flex-start;
    background: var(--purple-bg);
    border-bottom-left-radius: 4px;
  }
  .msg code {
    background: var(--bg);
    padding: 1px 4px;
    border-radius: 3px;
    font-family: var(--mono);
    font-size: 13px;
  }
  .msg pre {
    background: var(--bg);
    padding: 8px;
    border-radius: var(--radius-sm);
    margin: 6px 0;
    overflow-x: auto;
    font-family: var(--mono);
    font-size: 12px;
  }
  .chat-tool-activity {
    font-size: 12px;
    color: var(--text-dim);
    padding: 4px 8px;
    margin: 2px 0;
    border-left: 2px solid var(--border);
    font-family: var(--mono);
  }
  .chat-tool-activity .tool-name { color: var(--accent); }
  .chat-tool-activity .tool-result { color: var(--green); }
  .chat-bottom {
    border-top: 1px solid var(--border);
    padding: 10px 16px;
  }
  .chat-context-pills {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 8px;
  }
  .pill {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 3px 10px;
    font-size: 11px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: border-color .15s;
  }
  .pill:hover { border-color: var(--text-dim); }
  .pill .x { color: var(--accent); font-weight: bold; }
  .pill.add { border-style: dashed; color: var(--text-dim); }
  .chat-input-row {
    display: flex;
    gap: 8px;
    align-items: flex-end;
  }
  .chat-input-row textarea {
    flex: 1;
    resize: none;
    height: 42px;
    padding: 10px;
    font-size: 14px;
  }
  .chat-topbar {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
  }

  /* ═══════════════════════════════════════
     VIEW: GRAPH
     ═══════════════════════════════════════ */
  .graph-container {
    display: flex;
    height: 100%;
    overflow: hidden;
  }
  .graph-sidebar {
    width: 320px;
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    background: var(--surface);
    overflow-y: auto;
  }
  .graph-search-section {
    padding: 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 8px;
  }
  .graph-search-section input {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    font-size: 13px;
    font-family: var(--sans);
  }
  .graph-search-section input:focus {
    outline: none;
    border-color: var(--accent);
  }
  .graph-stats {
    padding: 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 16px;
  }
  .graph-stat-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .graph-stat-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .graph-stat-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--accent);
    font-family: var(--mono);
  }
  .graph-type-filters {
    padding: 16px;
    border-bottom: 1px solid var(--border);
  }
  .graph-filter-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-dim);
    margin-bottom: 12px;
  }
  .graph-filter-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    font-size: 13px;
    color: var(--text);
  }
  .graph-filter-checkbox input[type="checkbox"] {
    cursor: pointer;
  }
  .graph-results {
    flex: 1;
    overflow-y: auto;
  }
  .graph-results-title {
    padding: 12px 16px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border);
  }
  .graph-results-list {
    padding: 8px;
  }
  .graph-result-item {
    padding: 10px 12px;
    margin-bottom: 4px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background 0.15s;
    border: 1px solid transparent;
  }
  .graph-result-item:hover {
    background: var(--surface2);
    border-color: var(--border);
  }
  .graph-result-item.selected {
    background: var(--accent-bg);
    border-color: var(--accent);
  }
  .graph-result-id {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 4px;
  }
  .graph-result-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 2px;
  }
  .graph-result-type {
    display: inline-block;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 3px;
    background: var(--surface2);
    color: var(--text-dim);
    margin-right: 6px;
  }
  .graph-result-type.session { background: var(--purple-bg); color: var(--purple); }
  .graph-result-type.entity { background: var(--blue-bg); color: var(--blue); }
  .graph-result-type.person { background: var(--green-bg); color: var(--green); }
  .graph-result-type.decision { background: var(--accent-bg); color: var(--accent); }
  .graph-result-type.frustration { background: #4a1c1c; color: #ff6b6b; }
  .graph-result-type.preference { background: #1c3a1c; color: #a8e6a0; }
  .graph-result-meta {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 4px;
  }
  .graph-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .graph-detail {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }
  .graph-detail-empty {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-muted);
    font-size: 14px;
  }
  .graph-node-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
  }
  .graph-node-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }
  .graph-node-id {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text-muted);
  }
  .graph-node-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
  }
  .graph-node-section {
    margin-bottom: 16px;
  }
  .graph-node-section-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }
  .graph-node-section-content {
    font-size: 13px;
    color: var(--text);
    line-height: 1.6;
    white-space: pre-wrap;
  }
  .graph-neighbors-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .graph-neighbor-item {
    padding: 10px 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.15s;
  }
  .graph-neighbor-item:hover {
    background: var(--surface2);
    border-color: var(--accent);
  }
  .graph-neighbor-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
  }
  .graph-neighbor-name {
    font-weight: 600;
    font-size: 13px;
    color: var(--text);
  }
  .graph-neighbor-type {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 3px;
    background: var(--surface2);
    color: var(--text-dim);
  }
  .graph-neighbor-meta {
    font-size: 11px;
    color: var(--text-muted);
  }
  .graph-neighbor-type.frustration { background: #4a1c1c; color: #ff6b6b; }
  .graph-neighbor-type.preference { background: #1c3a1c; color: #a8e6a0; }

  /* Canvas */
  .graph-main { position: relative; }
  #graph-canvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    cursor: grab;
  }
  #graph-canvas.grabbing { cursor: grabbing; }
  #graph-canvas.pointer { cursor: pointer; }

  /* Floating toolbar */
  .graph-toolbar {
    position: absolute;
    top: 12px;
    left: 12px;
    display: flex;
    gap: 4px;
    align-items: center;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 4px 8px;
    z-index: 5;
    user-select: none;
  }
  .graph-toolbar button {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 14px;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    font-family: var(--sans);
  }
  .graph-toolbar button:hover { background: var(--surface2); color: var(--text); }
  .graph-toolbar .zoom-label {
    font-size: 11px;
    color: var(--text-muted);
    font-family: var(--mono);
    min-width: 36px;
    text-align: center;
  }

  /* Detail overlay */
  .graph-overlay {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 380px;
    background: var(--surface);
    border-left: 1px solid var(--border);
    transform: translateX(100%);
    transition: transform 0.25s ease;
    overflow-y: auto;
    z-index: 6;
    padding: 20px;
  }
  .graph-overlay.open { transform: translateX(0); }
  .graph-overlay-close {
    position: absolute;
    top: 12px;
    right: 12px;
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 18px;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
  }
  .graph-overlay-close:hover { background: var(--surface2); color: var(--text); }

  /* Graph chips */
  .graph-chip {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    margin: 2px 4px 2px 0;
    transition: border-color 0.15s;
  }
  .graph-chip:hover { border-color: var(--accent); }
  .graph-chip-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
  }

  /* Frustration/preference card tints */
  .graph-node-card.frustration { background: #1a1014; border-color: #4a1c1c; }
  .graph-node-card.preference { background: #101a14; border-color: #1c3a1c; }

  /* ═══════════════════════════════════════
     VIEW: ACTIVITY
     ═══════════════════════════════════════ */
  .activity-cards {
    display: flex;
    gap: 10px;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    flex-wrap: wrap;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 10px 16px;
    flex: 1;
    min-width: 120px;
    cursor: pointer;
    transition: border-color .15s;
  }
  .stat-card:hover { border-color: var(--text-dim); }
  .stat-card-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: .5px;
    color: var(--text-dim);
    margin-bottom: 4px;
  }
  .stat-card-value {
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
  }
  .stat-card-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
  .activity-body {
    flex: 1;
    display: grid;
    grid-template-columns: 3fr 2fr;
    overflow: hidden;
    margin-top: 12px;
  }
  .activity-feed {
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .activity-feed-title {
    padding: 10px 16px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .5px;
    color: var(--text-dim);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .activity-feed-items {
    flex: 1;
    overflow-y: auto;
    font-family: var(--mono);
    font-size: 12px;
    line-height: 1.8;
    padding: 8px 16px;
  }
  .feed-entry { padding: 2px 0; border-bottom: 1px solid var(--border-subtle); }
  .feed-time { color: var(--text-muted); margin-right: 10px; }
  .cost-panel {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .cost-panel-title {
    padding: 10px 16px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .5px;
    color: var(--text-dim);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .cost-panel-content {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
  }
  .budget-bar-bg {
    height: 18px;
    background: var(--surface2);
    border-radius: 9px;
    overflow: hidden;
    margin-bottom: 6px;
    border: 1px solid var(--border);
  }
  .budget-bar-fill {
    height: 100%;
    border-radius: 9px;
    background: var(--accent);
    transition: width .3s;
  }
  .budget-bar-fill.ok { background: var(--green); }
  .budget-bar-fill.warn { background: #cc8800; }
  .budget-bar-fill.over { background: var(--accent); }
  .budget-label {
    font-size: 12px;
    color: var(--text-dim);
    margin-bottom: 16px;
  }
  .spend-chart {
    display: flex;
    align-items: flex-end;
    gap: 6px;
    height: 80px;
    margin-bottom: 16px;
  }
  .spend-bar-col {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    height: 100%;
    justify-content: flex-end;
  }
  .spend-bar {
    width: 100%;
    background: var(--accent);
    border-radius: 3px 3px 0 0;
    min-height: 2px;
    transition: height .3s;
  }
  .spend-bar-label {
    font-size: 9px;
    color: var(--text-muted);
  }
  .cost-breakdown { margin-top: 8px; }
  .cost-breakdown-row {
    display: flex;
    justify-content: space-between;
    padding: 3px 0;
    font-size: 12px;
    border-bottom: 1px solid var(--border-subtle);
  }
  .cost-breakdown-role { color: var(--text-dim); }
  .cost-breakdown-val { color: var(--accent); font-weight: 600; font-family: var(--mono); }
  /* Last Task Card */
  .last-task-card {
    margin: 0 16px;
    padding: 12px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    flex-shrink: 0;
  }
  .last-task-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: .5px;
    color: var(--text-dim);
    margin-bottom: 6px;
  }
  .last-task-content {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }
  .last-task-id {
    font-family: var(--mono);
    font-size: 12px;
    font-weight: 600;
    color: var(--accent);
    cursor: pointer;
  }
  .last-task-id:hover { text-decoration: underline; }
  .last-task-preview {
    font-size: 13px;
    color: var(--text);
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .last-task-meta {
    font-size: 11px;
    color: var(--text-muted);
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .last-task-cost {
    font-family: var(--mono);
    font-size: 12px;
    font-weight: 600;
    color: var(--accent);
  }

  .journal-section {
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }
  .journal-toggle {
    padding: 10px 16px;
    cursor: pointer;
    font-size: 13px;
    color: var(--text-dim);
    transition: background .1s;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .journal-toggle:hover { background: var(--surface2); }
  .journal-toggle-arrow { transition: transform .2s; font-size: 10px; }
  .journal-toggle-arrow.open { transform: rotate(90deg); }
  .journal-body {
    display: none;
    padding: 0 16px 12px;
    font-family: var(--mono);
    font-size: 12px;
    white-space: pre-wrap;
    line-height: 1.6;
    max-height: 300px;
    overflow-y: auto;
    color: var(--text-dim);
  }
  .journal-body.show { display: block; }

  /* ═══════════════════════════════════════
     VIEW: SETTINGS
     ═══════════════════════════════════════ */
  .settings-nav {
    display: flex;
    gap: 4px;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    flex-wrap: wrap;
    background: var(--surface);
  }
  .settings-pill {
    padding: 5px 14px;
    border-radius: 14px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
    transition: all .15s;
  }
  .settings-pill:hover { border-color: var(--text-dim); color: var(--text); }
  .settings-pill.active { background: var(--accent-bg); border-color: var(--accent); color: var(--accent); }
  .settings-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }
  .settings-section { display: none; }
  .settings-section.active { display: block; }
  .form-section { margin-bottom: 24px; }
  .form-section h3 {
    font-size: 13px;
    color: var(--accent);
    margin-bottom: 12px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
  }
  .form-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
  }
  .form-row label {
    min-width: 140px;
    font-size: 13px;
    color: var(--text-dim);
    flex-shrink: 0;
  }
  .result-box {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    margin-top: 12px;
    font-family: var(--mono);
    font-size: 12px;
    white-space: pre-wrap;
    display: none;
  }
  .result-box.show { display: block; }

  /* Credentials table */
  .cred-table { width: 100%; border-collapse: collapse; }
  .cred-table th {
    text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: .5px;
    color: var(--text-dim); padding: 8px 12px; border-bottom: 1px solid var(--border);
  }
  .cred-table td { padding: 10px 12px; border-bottom: 1px solid var(--border-subtle); font-size: 13px; }
  .cred-input { display: none; gap: 8px; align-items: center; margin-top: 8px; }
  .cred-input.show { display: flex; }

  /* Model role rows */
  .model-role-row {
    padding: 10px 0;
    border-bottom: 1px solid var(--border-subtle);
  }
  .model-role-row:last-child { border-bottom: none; }
  .model-role-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
  }
  .model-role-header label {
    font-size: 13px;
    color: var(--text);
    font-weight: 600;
    text-transform: capitalize;
  }
  .model-role-controls {
    display: flex;
    gap: 8px;
  }
  .model-provider-select { width: 130px; flex-shrink: 0; }
  .model-picker {
    flex: 1;
    min-width: 0;
    position: relative;
  }
  .model-selected {
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg);
    cursor: pointer;
    font-size: 13px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .model-selected:hover { border-color: var(--text-dim); }
  .model-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 100;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    margin-top: 2px;
    box-shadow: 0 8px 24px rgba(0,0,0,.4);
    max-height: 300px;
    overflow: hidden;
    display: none;
    flex-direction: column;
  }
  .model-picker.open .model-dropdown { display: flex; }
  .model-search {
    border: none;
    border-bottom: 1px solid var(--border);
    padding: 8px 10px;
    font-size: 13px;
    background: transparent;
    color: var(--text);
    outline: none;
  }
  .model-list {
    overflow-y: auto;
    max-height: 260px;
  }
  .model-option {
    padding: 6px 10px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 1px;
  }
  .model-option:hover { background: var(--accent-bg); }
  .model-option.active { background: var(--accent-bg); }
  .model-option-name { font-size: 13px; color: var(--text); }
  .model-option-id { font-size: 11px; color: var(--text-dim); font-family: var(--mono); }
  .model-key-input {
    display: none;
    margin-top: 6px;
  }
  .model-key-input.show { display: block; }

  /* Channel cards */
  .channel-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 16px;
  }
  .channel-card h4 {
    margin: 0 0 12px 0;
    font-size: 14px;
    color: var(--text);
  }
  .channel-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    font-size: 13px;
  }
  .channel-row label {
    min-width: 90px;
    color: var(--text-dim);
    flex-shrink: 0;
  }
  .channel-status {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border-subtle);
    font-size: 13px;
    color: var(--text-dim);
  }

  /* Settings lists (crons, skills, tools) */
  .settings-list-item {
    padding: 8px 0;
    border-bottom: 1px solid var(--border-subtle);
    font-size: 13px;
  }
  .settings-list-item:last-child { border-bottom: none; }
  .settings-list-empty { color: var(--text-dim); font-size: 13px; font-style: italic; }

  /* Gateway status card in settings */
  .gw-status-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 16px;
    font-size: 13px;
    line-height: 1.8;
  }

  /* ═══════ MODAL ═══════ */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,.6);
    display: none; align-items: center; justify-content: center; z-index: 200;
  }
  .modal-overlay.show { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    width: 520px;
    max-height: 70vh;
    display: flex;
    flex-direction: column;
  }
  .modal-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 18px; border-bottom: 1px solid var(--border);
  }
  .modal-header h3 { font-size: 14px; color: var(--accent); }
  .modal-header .close { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 18px; }
  .modal-path {
    padding: 8px 18px; font-family: var(--mono); font-size: 12px;
    color: var(--text-dim); background: var(--bg);
    border-bottom: 1px solid var(--border); word-break: break-all;
  }
  .modal-body { flex: 1; overflow-y: auto; padding: 8px 0; }
  .folder-item {
    display: flex; align-items: center; padding: 8px 18px;
    cursor: pointer; font-size: 13px; gap: 8px; transition: background .1s;
  }
  .folder-item:hover { background: var(--surface2); }
  .folder-item .icon { color: var(--accent); width: 16px; }
  .folder-item.parent { color: var(--text-dim); }
  .modal-footer {
    display: flex; justify-content: flex-end; gap: 8px;
    padding: 12px 18px; border-top: 1px solid var(--border);
  }
</style>
</head>
<body>
<div class="app">

  <!-- ═══════ SIDEBAR ═══════ -->
  <div class="sidebar">
    <div class="sidebar-logo">BC</div>
    <div class="sidebar-nav">
      <div class="nav-item active" data-view="sessions">
        <svg viewBox="0 0 24 24"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/></svg>
        <span class="tooltip">Sessions</span>
      </div>
      <div class="nav-item" data-view="chat">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
        <span class="tooltip">Chat</span>
      </div>
      <div class="nav-item" data-view="activity">
        <svg viewBox="0 0 24 24"><path d="M13 2.05v2.02c3.95.49 7 3.85 7 7.93 0 3.73-2.56 6.86-6.02 7.75-.24.06-.49.1-.73.15L12 22c5.52-.17 9.83-4.75 9.83-10.28 0-4.93-3.5-9.04-8.15-9.98L13 2.05zM11 2.06C6.14 2.56 2.17 6.53 2.02 11.4L2 12c0 5.52 4.47 10 9.99 10l1.26-.02c-.25-.05-.49-.09-.74-.15C9.06 20.86 6.5 17.73 6.5 14c0-4.08 3.06-7.44 7-7.93V4.06L11 2.06zM12 6c-3.87 0-7 3.13-7 7s3.13 7 7 7 7-3.13 7-7-3.13-7-7-7zm-1 12v-2h2v2h-2zm0-4V8h2v6h-2z"/></svg>
        <span class="tooltip">Activity</span>
      </div>
      <div class="nav-item" data-view="graph">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
        <span class="tooltip">Graph Memory</span>
      </div>
      <div class="nav-item" data-view="settings">
        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.49.49 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.49.49 0 0 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6A3.6 3.6 0 1 1 12 8.4a3.6 3.6 0 0 1 0 7.2z"/></svg>
        <span class="tooltip">Settings</span>
      </div>
    </div>
  </div>

  <!-- ═══════ TOP BAR ═══════ -->
  <div class="topbar">
    <span class="topbar-title" id="view-title">Sessions</span>
    <div class="topbar-badges">
      <div class="status-badge" id="badge-cost">
        <span id="badge-cost-text">$0.00</span>
      </div>
      <div class="status-badge" id="badge-gateway">
        <div class="status-dot" id="gateway-dot"></div>
        <span id="badge-gateway-text">Gateway</span>
      </div>
    </div>
  </div>

  <!-- ═══════ CONTENT ═══════ -->
  <div class="content">

    <!-- ——— SESSIONS VIEW ——— -->
    <div class="view active" id="view-sessions">
      <div class="sessions-split">
        <div class="session-list-pane">
          <div class="session-search">
            <input type="text" id="session-search-input" placeholder="Search sessions...">
            <div class="session-filters">
              <span class="filter-pill active" data-filter="all">All</span>
              <span class="filter-pill" data-filter="chat">Chat</span>
              <span class="filter-pill" data-filter="heartbeat">Heartbeat</span>
              <span class="filter-pill" data-filter="cron">Cron</span>
            </div>
          </div>
          <div class="session-items" id="session-items"></div>
        </div>
        <div class="session-detail-pane" id="session-detail-pane">
          <div class="session-detail-empty">Select a session to view its trace</div>
        </div>
      </div>
    </div>

    <!-- ——— CHAT VIEW ——— -->
    <div class="view" id="view-chat">
      <div class="chat-topbar">
        <button class="btn sm secondary" id="chat-new">+ New</button>
        <select id="chat-session-picker"><option value="">Select session...</option></select>
        <span id="chat-cost" style="margin-left:auto;font-family:var(--mono);font-size:12px;color:var(--accent);font-weight:600;"></span>
      </div>
      <div class="chat-messages" id="chat-messages"></div>
      <div class="chat-bottom">
        <div class="chat-context-pills" id="chat-context-pills"></div>
        <div class="chat-input-row">
          <textarea id="chat-input" placeholder="Send a message..." rows="1"></textarea>
          <button class="btn" id="chat-send">Send</button>
        </div>
      </div>
    </div>

    <!-- ——— ACTIVITY VIEW ——— -->
    <div class="view" id="view-activity">
      <div class="activity-cards">
        <div class="stat-card" data-goto="settings">
          <div class="stat-card-label">Gateway</div>
          <div class="stat-card-value" id="act-gateway">--</div>
          <div class="stat-card-sub" id="act-gateway-sub"></div>
        </div>
        <div class="stat-card" data-goto="sessions">
          <div class="stat-card-label">Sessions</div>
          <div class="stat-card-value" id="act-sessions">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label">Today's Spend</div>
          <div class="stat-card-value" id="act-today-cost">--</div>
          <div class="stat-card-sub" id="act-today-calls"></div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label">Heartbeats</div>
          <div class="stat-card-value" id="act-hb">--</div>
          <div class="stat-card-sub" id="act-hb-sub"></div>
        </div>
      </div>

      <!-- Last Task Card -->
      <div class="last-task-card" id="last-task-card">
        <div class="last-task-label">Last Task</div>
        <div class="last-task-content" id="last-task-content">
          <span style="color:var(--text-muted);">Loading...</span>
        </div>
      </div>

      <div class="activity-body">
        <div class="activity-feed">
          <div class="activity-feed-title">Live Feed</div>
          <div class="activity-feed-items" id="activity-feed"></div>
        </div>
        <div class="cost-panel">
          <div class="cost-panel-title">Cost Analytics</div>
          <div class="cost-panel-content" id="cost-panel-content">
            <div id="budget-section"></div>
            <div style="font-size:12px;font-weight:600;color:var(--text-dim);margin-bottom:8px;margin-top:4px;">7-Day Spend</div>
            <div class="spend-chart" id="spend-chart"></div>
            <div style="font-size:12px;font-weight:600;color:var(--text-dim);margin-bottom:6px;">Today's Breakdown</div>
            <div class="cost-breakdown" id="cost-breakdown"></div>
            <div style="font-size:12px;font-weight:600;color:var(--text-dim);margin:16px 0 6px;">30-Day Total</div>
            <div id="cost-30day" style="font-size:20px;font-weight:700;color:var(--accent);font-family:var(--mono);"></div>
          </div>
        </div>
      </div>
      <div class="journal-section">
        <div class="journal-toggle" id="journal-toggle">
          <span class="journal-toggle-arrow" id="journal-arrow">&#9654;</span>
          Today's Journal
        </div>
        <div class="journal-body" id="journal-body"></div>
      </div>
    </div>

    <!-- ——— GRAPH VIEW ——— -->
    <div class="view" id="view-graph">
      <div class="graph-container">
        <div class="graph-sidebar">
          <div class="graph-search-section">
            <input type="text" id="graph-search-input" placeholder="Search graph..." autocomplete="off">
            <button class="btn sm" id="graph-search-btn">Search</button>
          </div>
          <div class="graph-stats" id="graph-stats">
            <div class="graph-stat-item">
              <span class="graph-stat-label">Nodes</span>
              <span class="graph-stat-value" id="stat-nodes">0</span>
            </div>
            <div class="graph-stat-item">
              <span class="graph-stat-label">Edges</span>
              <span class="graph-stat-value" id="stat-edges">0</span>
            </div>
          </div>
          <div class="graph-type-filters">
            <div class="graph-filter-title">Filter by Type</div>
            <label class="graph-filter-checkbox">
              <input type="checkbox" data-type="session" checked>
              <span>Sessions</span>
            </label>
            <label class="graph-filter-checkbox">
              <input type="checkbox" data-type="entity" checked>
              <span>Entities</span>
            </label>
            <label class="graph-filter-checkbox">
              <input type="checkbox" data-type="person" checked>
              <span>People</span>
            </label>
            <label class="graph-filter-checkbox">
              <input type="checkbox" data-type="decision" checked>
              <span>Decisions</span>
            </label>
            <label class="graph-filter-checkbox">
              <input type="checkbox" data-type="frustration" checked>
              <span>Frustrations</span>
            </label>
            <label class="graph-filter-checkbox">
              <input type="checkbox" data-type="preference" checked>
              <span>Preferences</span>
            </label>
          </div>
          <div class="graph-results" id="graph-results">
            <div class="graph-results-title">Search Results</div>
            <div class="graph-results-list" id="graph-results-list"></div>
          </div>
        </div>
        <div class="graph-main">
          <canvas id="graph-canvas"></canvas>
          <div class="graph-toolbar">
            <button id="graph-reload-btn" title="Reload graph from disk">&#8635;</button>
            <button id="graph-center-btn" title="Center view">&#8982;</button>
            <button id="graph-zoom-out" title="Zoom out">&minus;</button>
            <span class="zoom-label" id="graph-zoom-label">100%</span>
            <button id="graph-zoom-in" title="Zoom in">+</button>
          </div>
          <div class="graph-overlay" id="graph-overlay">
            <button class="graph-overlay-close" id="graph-overlay-close">&times;</button>
            <div id="graph-overlay-content"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ——— SETTINGS VIEW ——— -->
    <div class="view" id="view-settings">
      <div class="settings-nav">
        <span class="settings-pill active" data-section="general">General</span>
        <span class="settings-pill" data-section="models">Models</span>
        <span class="settings-pill" data-section="credentials">Credentials</span>
        <span class="settings-pill" data-section="channels">Channels</span>
        <span class="settings-pill" data-section="gateway">Gateway</span>
        <span class="settings-pill" data-section="crons">Crons</span>
        <span class="settings-pill" data-section="skills">Skills</span>
        <span class="settings-pill" data-section="tools">Tools</span>
      </div>
      <div class="settings-body">

        <!-- General -->
        <div class="settings-section active" id="settings-general">
          <form id="config-form">
            <div class="form-section">
              <h3>Paths</h3>
              <div class="form-row"><label>Vault Path</label><input type="text" name="vault" id="cfg-vault"><button type="button" class="btn sm secondary" id="cfg-vault-browse">Browse</button></div>
              <div class="form-row"><label>Daily Notes Dir</label><input type="text" name="dailyNotesDir" id="cfg-dailyNotesDir"></div>
              <div class="form-row"><label>Inbox Dir</label><input type="text" name="inboxDir" id="cfg-inboxDir"></div>
            </div>
            <div class="form-section">
              <h3>Compaction</h3>
              <div class="form-row"><label>Keep Recent</label><input type="number" name="compaction.keepRecentMessages" id="cfg-keepRecent"></div>
              <div class="form-row"><label>Max Before Compact</label><input type="number" name="compaction.maxMessagesBeforeCompact" id="cfg-maxCompact"></div>
            </div>
            <div class="form-section">
              <h3>Budget</h3>
              <div class="form-row"><label>Daily Limit (USD)</label><input type="number" step="0.1" name="budget.dailyLimit" id="cfg-dailyLimit"></div>
              <div class="form-row"><label>Warn At (USD)</label><input type="number" step="0.1" name="budget.warnAt" id="cfg-warnAt"></div>
            </div>
            <button type="submit" class="btn">Save Config</button>
          </form>
        </div>

        <!-- Models -->
        <div class="settings-section" id="settings-models">
          <div class="form-section">
            <h3>Model Configuration</h3>
            <div id="cfg-models"></div>
            <button type="button" class="btn" id="models-save" style="margin-top:12px;">Save Models</button>
          </div>
        </div>

        <!-- Credentials -->
        <div class="settings-section" id="settings-credentials">
          <table class="cred-table">
            <thead><tr><th>Key</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="cred-tbody"></tbody>
          </table>
        </div>

        <!-- Channels -->
        <div class="settings-section" id="settings-channels">
          <div class="form-section">
            <h3>Notification Channels</h3>
            <div class="form-row" style="margin-bottom:16px;">
              <label>Default Channel</label>
              <select id="ch-default"></select>
              <button class="btn sm" id="ch-default-save">Save</button>
            </div>
          </div>
          <div id="ch-cards"></div>
        </div>

        <!-- Gateway -->
        <div class="settings-section" id="settings-gateway">
          <div class="gw-status-card" id="gw-status"></div>
          <div class="form-section">
            <h3>Heartbeat</h3>
            <div class="form-row">
              <label>Interval (min)</label>
              <input type="number" id="hb-interval" style="width:80px;flex:unset;" min="1">
            </div>
            <div class="form-row">
              <label>Sources</label>
              <div style="display:flex;gap:12px;">
                <label style="min-width:unset;display:flex;align-items:center;gap:4px;"><input type="checkbox" id="hb-src-inbox" value="inbox"> Inbox</label>
                <label style="min-width:unset;display:flex;align-items:center;gap:4px;"><input type="checkbox" id="hb-src-tasks" value="tasks"> Tasks</label>
                <label style="min-width:unset;display:flex;align-items:center;gap:4px;"><input type="checkbox" id="hb-src-github" value="github"> GitHub</label>
              </div>
            </div>
            <div class="form-row">
              <label>Proactive</label>
              <label style="min-width:unset;display:flex;align-items:center;gap:4px;"><input type="checkbox" id="hb-proactive"> Check in when idle</label>
            </div>
            <div style="display:flex;gap:8px;margin-top:12px;">
              <button class="btn" id="hb-save">Save Heartbeat</button>
              <button class="btn secondary" id="hb-run">Run Now</button>
            </div>
            <div class="result-box" id="hb-result"></div>
          </div>
          <div class="form-section">
            <h3>Doctor</h3>
            <p style="font-size:13px;color:var(--text-dim);margin-bottom:10px;">Validate custom tools, clean quarantine, check credential alignment.</p>
            <button class="btn secondary" id="doctor-run">Run Doctor</button>
            <div class="result-box" id="doctor-result"></div>
          </div>
        </div>

        <!-- Crons -->
        <div class="settings-section" id="settings-crons">
          <div class="form-section">
            <h3>Cron Jobs</h3>
            <div id="crons-list"></div>
          </div>
        </div>

        <!-- Skills -->
        <div class="settings-section" id="settings-skills">
          <div class="form-section">
            <h3>Skills</h3>
            <div id="skills-list"></div>
          </div>
        </div>

        <!-- Tools -->
        <div class="settings-section" id="settings-tools">
          <div class="form-section">
            <h3>Custom Tools</h3>
            <div id="tools-list"></div>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- ═══════ BOTTOM BAR ═══════ -->
  <div class="bottombar">
    <div class="bottombar-dot" id="bottombar-dot"></div>
    <span id="bottombar-text">Starting up...</span>
  </div>

</div>

<!-- ═══════ FOLDER BROWSER MODAL ═══════ -->
<div class="modal-overlay" id="browse-modal">
  <div class="modal">
    <div class="modal-header">
      <h3>Browse for Folder</h3>
      <button class="close" id="browse-close">&times;</button>
    </div>
    <div id="browse-bookmarks" style="display:flex;gap:6px;padding:8px 18px;flex-wrap:wrap;border-bottom:1px solid var(--border);"></div>
    <div class="modal-path" id="browse-path"></div>
    <div class="modal-body" id="browse-list"></div>
    <div class="modal-footer">
      <button class="btn secondary" id="browse-cancel">Cancel</button>
      <button class="btn" id="browse-select">Select This Folder</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

// ═══════ HELPERS ═══════

function toast(msg) {
  const t = $('#toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

async function api(path, opts = {}) {
  const res = await fetch(`/api/${path}`, {
    method: opts.method || 'GET',
    headers: opts.body ? { 'Content-Type': 'application/json' } : {},
    body: opts.body ? JSON.stringify(opts.body) : undefined,
  });
  if (opts.stream) return res;
  return res.json();
}

function escapeHtml(str) {
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function formatCharCount(n) {
  if (n >= 1000) return `${(n / 1000).toFixed(1)}k`;
  return String(n);
}

function timeAgo(dateStr) {
  if (!dateStr) return '';
  const ms = Date.now() - new Date(dateStr).getTime();
  const sec = Math.floor(ms / 1000);
  if (sec < 60) return `${sec}s ago`;
  const min = Math.floor(sec / 60);
  if (min < 60) return `${min}m ago`;
  const hr = Math.floor(min / 60);
  if (hr < 24) return `${hr}h ago`;
  const days = Math.floor(hr / 24);
  return `${days}d ago`;
}

function renderMarkdownLite(text) {
  return text
    .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/^- (.+)/gm, '&bull; $1')
    .replace(/\n/g, '<br>');
}

// ═══════ NAVIGATION ═══════

const VIEW_TITLES = { sessions: 'Sessions', chat: 'Chat', activity: 'Activity', graph: 'Graph Memory', settings: 'Settings' };
let currentView = 'sessions';
let polls = {};

function switchView(view) {
  // Stop all polls
  Object.values(polls).forEach(id => clearInterval(id));
  polls = {};

  currentView = view;
  $$('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.view === view));
  $$('.view').forEach(v => v.classList.toggle('active', v.id === `view-${view}`));
  $('#view-title').textContent = VIEW_TITLES[view] || view;

  if (view === 'sessions') { loadSessionsList(); polls.sessions = setInterval(loadSessionsList, 10000); }
  if (view === 'chat') initChat();
  if (view === 'activity') { loadActivity(); polls.feed = setInterval(loadGatewayFeed, 2000); }
  if (view !== 'graph' && graphViz.animFrame) { cancelAnimationFrame(graphViz.animFrame); graphViz.animFrame = null; }
  if (view === 'graph') loadGraphView();
  if (view === 'settings') loadSettingsSection();
}

$$('.nav-item').forEach(item => {
  item.addEventListener('click', () => switchView(item.dataset.view));
});

// Stat card click navigation
$$('.stat-card[data-goto]').forEach(card => {
  card.addEventListener('click', () => switchView(card.dataset.goto));
});

// ═══════ TOP BAR STATUS ═══════

async function updateTopBar() {
  try {
    const [status, costs] = await Promise.all([api('status'), api('costs')]);

    // Gateway dot
    const dot = $('#gateway-dot');
    const gwText = $('#badge-gateway-text');
    if (status.gateway?.running) {
      dot.classList.add('on');
      dot.classList.remove('off');
      gwText.textContent = 'Gateway';
    } else {
      dot.classList.remove('on');
      dot.classList.add('off');
      gwText.textContent = 'Offline';
    }

    // Today's cost
    const today = costs.length > 0 ? costs[0] : null;
    const todayCost = today ? today.totalCost : 0;
    $('#badge-cost-text').textContent = `$${todayCost.toFixed(2)}`;
  } catch {}
}

// ═══════ BOTTOM BAR ═══════

let lastTickerText = '';
async function updateTicker() {
  try {
    const log = await api('gateway/log');
    if (log.length > 0) {
      const last = log[log.length - 1];
      const t = new Date(last.time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
      const text = `${t}  ${last.text}`;
      if (text !== lastTickerText) {
        lastTickerText = text;
        $('#bottombar-text').textContent = text;
        $('#bottombar-dot').style.background = 'var(--green)';
      }
    } else {
      $('#bottombar-text').textContent = 'No gateway activity';
      $('#bottombar-dot').style.background = 'var(--text-muted)';
    }
  } catch {
    $('#bottombar-text').textContent = 'Gateway not connected';
    $('#bottombar-dot').style.background = 'var(--text-muted)';
  }
}

// ═══════ SESSIONS VIEW ═══════

let allSessions = [];
let activeSessionFilter = 'all';
let activeSessionId = null;

function guessSessionType(s) {
  const preview = (s.lastMessage || '').toLowerCase();
  const id = (s.id || '').toLowerCase();
  if (id.startsWith('hb-') || id.startsWith('heartbeat') || preview.includes('heartbeat')) return 'heartbeat';
  if (id.startsWith('cron-') || preview.includes('cron')) return 'cron';
  return 'chat';
}

async function loadSessionsList() {
  try {
    const sessions = await api('sessions');
    allSessions = sessions;
    renderSessionList();
  } catch {}
}

function renderSessionList() {
  const query = ($('#session-search-input').value || '').toLowerCase();
  const container = $('#session-items');

  let filtered = allSessions;

  // Filter by type
  if (activeSessionFilter !== 'all') {
    filtered = filtered.filter(s => guessSessionType(s) === activeSessionFilter);
  }

  // Filter by search
  if (query) {
    filtered = filtered.filter(s =>
      (s.id || '').toLowerCase().includes(query) ||
      (s.lastMessage || '').toLowerCase().includes(query)
    );
  }

  if (filtered.length === 0) {
    container.innerHTML = `<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:13px;">No sessions found</div>`;
    return;
  }

  container.innerHTML = filtered.slice(0, 50).map(s => {
    const type = guessSessionType(s);
    const stats = s.stats || {};
    const cost = s.cost || {};
    const tokStr = stats.estTokens ? `~${formatCharCount(stats.estTokens)} tok` : '';
    const toolStr = stats.toolCalls ? `${stats.toolCalls} tools` : '';
    const costStr = cost.total ? `$${cost.total.toFixed(4)}` : '';
    const statParts = [toolStr, tokStr].filter(Boolean).join(' \u00b7 ');
    const active = s.id === activeSessionId ? ' active' : '';
    return `<div class="session-item${active}" data-id="${s.id}">
      <div class="session-item-header">
        <span class="session-item-type type-${type}">${type}</span>
        <span class="session-item-id">${s.id.slice(0, 10)}</span>
        ${costStr ? `<span class="session-item-cost">${costStr}</span>` : ''}
        <span class="session-item-time">${timeAgo(s.created)}</span>
      </div>
      <div class="session-item-preview">${escapeHtml((s.lastMessage || '').slice(0, 80))}</div>
      <div class="session-item-stats">
        <span>${s.messageCount || 0} msgs</span>
        ${statParts ? `<span>${statParts}</span>` : ''}
      </div>
    </div>`;
  }).join('');

  container.querySelectorAll('.session-item').forEach(item => {
    item.addEventListener('click', () => {
      activeSessionId = item.dataset.id;
      // Highlight active
      container.querySelectorAll('.session-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      loadSessionDetail(item.dataset.id);
    });
  });
}

// Filter pills
$$('.filter-pill').forEach(pill => {
  pill.addEventListener('click', () => {
    $$('.filter-pill').forEach(p => p.classList.remove('active'));
    pill.classList.add('active');
    activeSessionFilter = pill.dataset.filter;
    renderSessionList();
  });
});

// Search input
$('#session-search-input').addEventListener('input', () => renderSessionList());

// Session detail trace rendering

let _traceUid = 0;
function traceId() { return `trace-${++_traceUid}`; }

function renderTextBlock(role, text, uid) {
  const len = text.length;
  const preview = text.replace(/\n/g, ' ').slice(0, 120);
  const truncated = len > 200;
  return `<div class="trace-msg">
    <div class="trace-header">
      <span class="trace-role ${role}">${role.toUpperCase()}</span>
      <span class="trace-chars">${formatCharCount(len)} chars</span>
      <span class="trace-preview">${escapeHtml(preview)}${truncated ? '...' : ''}</span>
      ${truncated ? `<button class="trace-expand" onclick="document.getElementById('${uid}').classList.toggle('show');this.textContent=this.textContent==='\u25B8'?'\u25BE':'\u25B8'">\u25B8</button>` : ''}
    </div>
    ${truncated ? `<div class="trace-body" id="${uid}">${escapeHtml(text)}</div>` : ''}
  </div>`;
}

function renderToolUse(block, uid) {
  const argsStr = JSON.stringify(block.input || {}, null, 2);
  const argsPreview = JSON.stringify(block.input || {}).slice(0, 100);
  return `<div class="trace-tool">
    <div class="trace-header" onclick="document.getElementById('${uid}').classList.toggle('show')">
      <span class="trace-tool-name">${escapeHtml(block.name)}</span>
      <span class="trace-tool-args">${escapeHtml(argsPreview)}</span>
      <span class="trace-tool-id">${block.id ? block.id.slice(-6) : ''}</span>
      <button class="trace-expand">\u25B8</button>
    </div>
    <div class="trace-body" id="${uid}">${escapeHtml(argsStr)}</div>
  </div>`;
}

function renderToolResult(content, uid) {
  const text = typeof content === 'string' ? content : JSON.stringify(content || '', null, 2);
  const len = text.length;
  const preview = text.replace(/\n/g, ' ').slice(0, 100);
  return `<div class="trace-result">
    <div class="trace-header" onclick="document.getElementById('${uid}').classList.toggle('show')">
      <span class="trace-result-label">result</span>
      <span class="trace-chars">${formatCharCount(len)} chars</span>
      <span class="trace-preview">${escapeHtml(preview)}${len > 100 ? '...' : ''}</span>
      <button class="trace-expand">\u25B8</button>
    </div>
    <div class="trace-body" id="${uid}">${escapeHtml(text)}</div>
  </div>`;
}

let allExpanded = false;

async function loadSessionDetail(id) {
  const pane = $('#session-detail-pane');
  pane.innerHTML = '<div class="session-detail-empty"><span class="spinner">Loading</span></div>';
  try {
    const data = await api(`sessions/${id}`);
    const allMessages = [...(data.history || []), ...(data.messages || [])];
    const stats = data.stats || {};
    const cost = data.cost || {};

    // Build header
    const costHtml = cost.total
      ? `<span style="color:var(--accent);font-family:var(--mono);font-weight:700;">$${cost.total.toFixed(4)}</span>
         <span style="color:var(--text-muted);font-size:11px;">${cost.calls || 0} calls \u00b7 ${formatCharCount(cost.input || 0)} in \u00b7 ${formatCharCount(cost.output || 0)} out</span>`
      : '';
    let headerHtml = `<div class="session-detail-header">
      <span class="session-detail-id">${id}</span>
      <div class="session-detail-stats">
        <span>${allMessages.length} msgs</span>
        ${stats.toolCalls ? `<span>${stats.toolCalls} tools</span>` : ''}
        ${stats.estTokens ? `<span>~${formatCharCount(stats.estTokens)} tok</span>` : ''}
        ${costHtml}
      </div>
      <div class="session-detail-actions">
        <button class="btn sm secondary" id="trace-expand-all">Expand All</button>
      </div>
    </div>`;

    // Build trace
    const traceHtml = [];
    for (const msg of allMessages) {
      const role = msg.role || 'unknown';
      if (typeof msg.content === 'string') {
        traceHtml.push(renderTextBlock(role, msg.content, traceId()));
        continue;
      }
      if (Array.isArray(msg.content)) {
        for (const block of msg.content) {
          if (block.type === 'text') {
            traceHtml.push(renderTextBlock(role, block.text, traceId()));
          } else if (block.type === 'tool_use') {
            traceHtml.push(renderToolUse(block, traceId()));
          } else if (block.type === 'tool_result') {
            traceHtml.push(renderToolResult(block.content, traceId()));
          } else {
            traceHtml.push(renderTextBlock(role, JSON.stringify(block), traceId()));
          }
        }
        continue;
      }
      // OpenAI tool_calls format
      if (msg.tool_calls) {
        if (msg.content) traceHtml.push(renderTextBlock('assistant', msg.content, traceId()));
        for (const tc of msg.tool_calls) {
          traceHtml.push(renderToolUse({
            name: tc.function?.name || tc.name || '?',
            input: (() => { try { return JSON.parse(tc.function?.arguments || '{}'); } catch { return {}; } })(),
            id: tc.id,
          }, traceId()));
        }
        continue;
      }
      // OpenAI tool result
      if (role === 'tool') {
        traceHtml.push(renderToolResult(msg.content, traceId()));
        continue;
      }
      traceHtml.push(renderTextBlock(role, JSON.stringify(msg.content || ''), traceId()));
    }

    pane.innerHTML = headerHtml + `<div class="session-trace">${traceHtml.join('')}</div>`;

    // Expand/collapse all
    allExpanded = false;
    const expandBtn = pane.querySelector('#trace-expand-all');
    if (expandBtn) {
      expandBtn.addEventListener('click', () => {
        allExpanded = !allExpanded;
        pane.querySelectorAll('.trace-body').forEach(b => b.classList.toggle('show', allExpanded));
        expandBtn.textContent = allExpanded ? 'Collapse All' : 'Expand All';
      });
    }
  } catch (err) {
    pane.innerHTML = `<div class="session-detail-empty" style="color:var(--accent);">Error: ${err.message}</div>`;
  }
}

// ═══════ CHAT VIEW ═══════

let chatSessionId = null;
let chatContexts = [];

async function initChat() {
  const sessions = await api('sessions');
  const picker = $('#chat-session-picker');
  picker.innerHTML = '<option value="">Select session...</option>';
  for (const s of sessions) {
    const opt = document.createElement('option');
    opt.value = s.id;
    const costStr = s.cost?.total ? ` · $${s.cost.total.toFixed(4)}` : '';
    opt.textContent = `${s.id} (${s.messageCount} msgs${costStr})`;
    if (s.id === chatSessionId) opt.selected = true;
    picker.appendChild(opt);
  }
  updateChatCost();
  updateContextPills();
}

function updateChatCost() {
  const el = $('#chat-cost');
  if (!chatSessionId) { el.textContent = ''; return; }
  const session = allSessions.find(s => s.id === chatSessionId);
  if (session?.cost?.total) {
    el.textContent = `$${session.cost.total.toFixed(4)}`;
  } else {
    el.textContent = '';
  }
}

$('#chat-new').addEventListener('click', async () => {
  const data = await api('chat/new', { method: 'POST' });
  chatSessionId = data.id;
  chatContexts = [];
  $('#chat-messages').innerHTML = '';
  toast(`New session: ${data.id}`);
  initChat();
});

$('#chat-session-picker').addEventListener('change', async (e) => {
  const id = e.target.value;
  if (!id) return;
  chatSessionId = id;
  const sessions = await api('sessions');
  const session = sessions.find(s => s.id === id);
  chatContexts = session?.contexts || [];
  $('#chat-messages').innerHTML = '';
  try {
    await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sessionId: id, message: '' }),
    });
  } catch {}
  updateChatCost();
  updateContextPills();
  toast(`Switched to ${id}`);
});

async function updateContextPills() {
  const pills = $('#chat-context-pills');
  const allCtx = await api('contexts');
  pills.innerHTML = '';

  for (const name of chatContexts) {
    const pill = document.createElement('span');
    pill.className = 'pill';
    pill.innerHTML = `${escapeHtml(name)} <span class="x">x</span>`;
    pill.querySelector('.x').addEventListener('click', async () => {
      if (!chatSessionId) return;
      await api('chat/context', { method: 'POST', body: { sessionId: chatSessionId, action: 'unload', name } });
      chatContexts = chatContexts.filter(c => c !== name);
      updateContextPills();
    });
    pills.appendChild(pill);
  }

  const addPill = document.createElement('span');
  addPill.className = 'pill add';
  addPill.textContent = '+ context';
  addPill.addEventListener('click', () => {
    const available = allCtx.filter(c => !chatContexts.includes(c.name));
    if (available.length === 0) { toast('No more contexts'); return; }
    const name = prompt('Load context:\n' + available.map(c => `  ${c.name} (~${c.tokens} tok)`).join('\n') + '\n\nEnter name:');
    if (!name || !available.find(c => c.name === name)) return;
    if (!chatSessionId) { toast('Create a session first'); return; }
    api('chat/context', { method: 'POST', body: { sessionId: chatSessionId, action: 'load', name } }).then(() => {
      chatContexts.push(name);
      updateContextPills();
    });
  });
  pills.appendChild(addPill);
}

function addMessage(role, content) {
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.innerHTML = renderMarkdownLite(content);
  $('#chat-messages').appendChild(div);
  $('#chat-messages').scrollTop = $('#chat-messages').scrollHeight;
  return div;
}

const TOOL_ICONS = {
  search_vault: '\u{1F50D}', read_file: '\u{1F4D6}', write_file: '\u270F\uFE0F',
  list_files: '\u{1F4C1}', journal_append: '\u{1F4DD}', journal_read: '\u{1F4C5}',
  find_recent_files: '\u{1F550}', list_contexts: '\u{1F4DA}', load_context: '\u{1F517}',
  spawn_subagent: '\u{1F916}', check_email: '\u{1F4E7}', read_email: '\u{1F4E8}',
  send_email: '\u{1F4E4}', store_credential: '\u{1F511}', get_credential: '\u{1F511}',
  create_skill: '\u{1F4DA}', list_skills: '\u{1F4CB}', load_skill: '\u{1F4D6}',
  delete_skill: '\u{1F5D1}', create_tool: '\u{1F527}', list_custom_tools: '\u{1F9F0}',
  view_tool_source: '\u{1F4C4}', delete_tool: '\u{1F5D1}',
  create_cron: '\u{23F0}', list_crons: '\u{1F4CB}', update_cron: '\u{1F504}',
  enable_cron: '\u2705', disable_cron: '\u23F8\uFE0F', delete_cron: '\u{1F5D1}',
};

async function sendChat() {
  const input = $('#chat-input');
  const message = input.value.trim();
  if (!message) return;
  if (!chatSessionId) {
    const data = await api('chat/new', { method: 'POST' });
    chatSessionId = data.id;
    initChat();
  }

  addMessage('user', message);
  input.value = '';

  let assistantDiv = addMessage('assistant', '');
  let fullText = '';

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sessionId: chatSessionId, message }),
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop();
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        try {
          const event = JSON.parse(line.slice(6));
          if (event.type === 'text') {
            fullText += event.text;
            assistantDiv.innerHTML = renderMarkdownLite(fullText);
            $('#chat-messages').scrollTop = $('#chat-messages').scrollHeight;
          } else if (event.type === 'tool_start') {
            const icon = TOOL_ICONS[event.name] || '\u26A1';
            const argsStr = Object.entries(event.arguments || {}).map(([k,v]) => `${k}=${typeof v === 'string' ? v.slice(0,40) : v}`).join(', ');
            const toolDiv = document.createElement('div');
            toolDiv.className = 'chat-tool-activity';
            toolDiv.innerHTML = `${icon} <span class="tool-name">${escapeHtml(event.name)}</span>(${escapeHtml(argsStr)})`;
            $('#chat-messages').appendChild(toolDiv);
            $('#chat-messages').scrollTop = $('#chat-messages').scrollHeight;
          } else if (event.type === 'tool_result') {
            const preview = (event.result || '').split('\n').slice(0,2).join(' ').slice(0,120);
            const resultDiv = document.createElement('div');
            resultDiv.className = 'chat-tool-activity';
            resultDiv.innerHTML = `\u2192 <span class="tool-result">${escapeHtml(preview)}</span>`;
            $('#chat-messages').appendChild(resultDiv);
            fullText = '';
            assistantDiv = addMessage('assistant', '');
          } else if (event.type === 'error') {
            fullText += `\n[Error: ${event.error}]`;
            assistantDiv.innerHTML = renderMarkdownLite(fullText);
          }
        } catch {}
      }
    }
    if (!fullText.trim() && assistantDiv.parentNode) {
      assistantDiv.parentNode.removeChild(assistantDiv);
    }
  } catch (err) {
    assistantDiv.innerHTML = renderMarkdownLite(`[Error: ${err.message}]`);
  }
}

$('#chat-send').addEventListener('click', sendChat);
$('#chat-input').addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
});

// ═══════ ACTIVITY VIEW ═══════

async function loadActivity() {
  await Promise.all([loadActivityCards(), loadGatewayFeed(), loadCostPanel(), loadJournal(), loadLastTask()]);
}

async function loadActivityCards() {
  try {
    const data = await api('status');

    // Gateway
    if (data.gateway?.running) {
      $('#act-gateway').textContent = 'Online';
      $('#act-gateway').style.color = 'var(--green)';
      const upMin = data.gateway.startedAt ? Math.floor((Date.now() - new Date(data.gateway.startedAt).getTime()) / 60000) : 0;
      $('#act-gateway-sub').textContent = upMin > 60 ? `Up ${Math.floor(upMin/60)}h ${upMin%60}m` : `Up ${upMin}m`;
    } else {
      $('#act-gateway').textContent = 'Offline';
      $('#act-gateway').style.color = 'var(--accent)';
      $('#act-gateway-sub').textContent = '';
    }

    // Sessions
    $('#act-sessions').textContent = data.sessions;

    // Heartbeats
    const hbCount = data.gateway?.heartbeatCount || 0;
    $('#act-hb').textContent = hbCount;
    const lastHb = data.gateway?.lastHeartbeat || data.heartbeat?.lastRun;
    if (lastHb) {
      const ago = Math.floor((Date.now() - new Date(lastHb).getTime()) / 60000);
      $('#act-hb-sub').textContent = `Last: ${ago}m ago`;
    }
  } catch {}
}

async function loadGatewayFeed() {
  try {
    const log = await api('gateway/log');
    const div = $('#activity-feed');
    if (log.length === 0) {
      div.innerHTML = '<div style="padding:12px;color:var(--text-muted);">No activity yet.</div>';
      return;
    }
    div.innerHTML = log.slice().reverse().map(e => {
      const t = new Date(e.time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
      return `<div class="feed-entry"><span class="feed-time">${t}</span>${escapeHtml(e.text)}</div>`;
    }).join('');
  } catch {}
}

async function loadCostPanel() {
  try {
    const costs = await api('costs');
    const cfg = await api('config');
    const dailyLimit = cfg.current?.budget?.dailyLimit || 2.0;
    const warnAt = cfg.current?.budget?.warnAt || 1.5;

    // Today's cost
    const today = costs.length > 0 ? costs[0] : null;
    const todayCost = today ? today.totalCost : 0;
    $('#act-today-cost').textContent = `$${todayCost.toFixed(2)}`;
    $('#act-today-calls').textContent = today ? `${today.calls} API calls` : '';

    // 30-day total
    const total30 = costs.reduce((sum, c) => sum + (c.totalCost || 0), 0);
    const total30Calls = costs.reduce((sum, c) => sum + (c.calls || 0), 0);
    const el30 = $('#cost-30day');
    if (el30) el30.innerHTML = `$${total30.toFixed(2)} <span style="font-size:12px;color:var(--text-muted);font-weight:400;">${total30Calls} calls across ${costs.length} days</span>`;

    // Budget bar
    const pct = Math.min((todayCost / dailyLimit) * 100, 100);
    let barClass = 'ok';
    if (todayCost >= dailyLimit) barClass = 'over';
    else if (todayCost >= warnAt) barClass = 'warn';
    $('#budget-section').innerHTML = `
      <div class="budget-bar-bg"><div class="budget-bar-fill ${barClass}" style="width:${pct}%"></div></div>
      <div class="budget-label">$${todayCost.toFixed(2)} / $${dailyLimit.toFixed(2)} daily limit</div>
    `;

    // 7-day chart
    const last7 = costs.slice(0, 7).reverse();
    const maxSpend = Math.max(...last7.map(c => c.totalCost), 0.01);
    const chart = $('#spend-chart');
    const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const todayDate = new Date().toISOString().slice(0, 10);
    chart.innerHTML = last7.map(c => {
      const h = Math.max((c.totalCost / maxSpend) * 60, 2);
      const d = new Date(c.date + 'T12:00:00');
      const label = days[d.getDay()] || c.date.slice(5);
      const isToday = c.date === todayDate;
      const barColor = isToday ? 'var(--accent)' : 'var(--blue)';
      return `<div class="spend-bar-col">
        <div style="font-size:9px;color:var(--text-muted);margin-bottom:2px;">$${c.totalCost.toFixed(2)}</div>
        <div class="spend-bar" style="height:${h}px;background:${barColor};" title="${c.date}: $${c.totalCost.toFixed(4)} (${c.calls} calls)"></div>
        <div class="spend-bar-label">${isToday ? 'Today' : label}</div>
      </div>`;
    }).join('');

    // Breakdown
    const breakdown = $('#cost-breakdown');
    if (today?.byRole) {
      breakdown.innerHTML = Object.entries(today.byRole).map(([role, d]) =>
        `<div class="cost-breakdown-row">
          <span class="cost-breakdown-role">${role}</span>
          <span class="cost-breakdown-val">$${d.cost.toFixed(3)}</span>
        </div>`
      ).join('');
    } else {
      breakdown.innerHTML = '<div style="color:var(--text-muted);font-size:12px;">No data today</div>';
    }
  } catch {}
}

async function loadJournal() {
  try {
    const status = await api('status');
    $('#journal-body').textContent = status.journal || 'No journal entry for today.';
  } catch {}
}

async function loadLastTask() {
  try {
    const sessions = await api('sessions');
    const div = $('#last-task-content');
    if (!sessions || sessions.length === 0) {
      div.innerHTML = '<span style="color:var(--text-muted);">No sessions yet</span>';
      return;
    }
    const last = sessions[0]; // Already sorted newest first
    const type = guessSessionType(last);
    const cost = last.cost || {};
    const stats = last.stats || {};
    div.innerHTML = `
      <span class="session-item-type type-${type}" style="font-size:10px;">${type}</span>
      <span class="last-task-id" onclick="switchView('sessions');setTimeout(()=>{activeSessionId='${last.id}';renderSessionList();loadSessionDetail('${last.id}')},100)">${last.id.slice(0, 10)}</span>
      <span class="last-task-preview">${escapeHtml((last.lastMessage || 'No message').slice(0, 100))}</span>
      <div class="last-task-meta">
        <span>${timeAgo(last.updated || last.created)}</span>
        <span>${last.messageCount || 0} msgs</span>
        ${stats.toolCalls ? `<span>${stats.toolCalls} tools</span>` : ''}
        ${cost.total ? `<span class="last-task-cost">$${cost.total.toFixed(4)}</span>` : ''}
      </div>
    `;
  } catch {}
}

$('#journal-toggle').addEventListener('click', () => {
  const body = $('#journal-body');
  const arrow = $('#journal-arrow');
  body.classList.toggle('show');
  arrow.classList.toggle('open');
});

// ═══════ GRAPH VIEW ═══════

let selectedGraphNode = null;
let graphTypeFilters = { session: true, entity: true, person: true, decision: true, frustration: true, preference: true };

const NODE_COLORS = {
  session: '#b388ff', entity: '#6699cc', person: '#52b788',
  decision: '#e94560', frustration: '#ff6b6b', preference: '#a8e6a0'
};

const graphViz = {
  nodes: [], edges: [], nodeMap: {}, rawData: null,
  offsetX: 0, offsetY: 0, zoom: 1,
  dragging: null, panning: false, panStart: null,
  hoveredNode: null, selectedNode: null,
  searchMatches: new Set(), searchActive: false,
  temperature: 1, animFrame: null, canvasReady: false
};

function buildGraphData(apiData) {
  graphViz.rawData = apiData;
  const allNodes = apiData.nodes || [];
  const allEdges = apiData.edges || [];
  const filtered = allNodes.filter(n => graphTypeFilters[n.type] !== false);
  const idSet = new Set(filtered.map(n => n.id));

  const canvas = $('#graph-canvas');
  const cx = (canvas.width / devicePixelRatio) / 2;
  const cy = (canvas.height / devicePixelRatio) / 2;

  graphViz.nodeMap = {};
  graphViz.nodes = filtered.map((n, i) => {
    graphViz.nodeMap[n.id] = i;
    const edgeCount = allEdges.filter(e => e.source === n.id || e.target === n.id).length;
    const radius = Math.min(20, Math.max(6, 6 + edgeCount * 1.5 + (n.mentions || 0) * 0.5));
    const label = n.name || (n.summary || '').slice(0, 30) || (n.text || '').slice(0, 30) || n.id.split(':')[1] || n.id;
    const angle = (i / filtered.length) * Math.PI * 2;
    const spread = Math.min(cx, cy) * 0.6;
    return {
      id: n.id, type: n.type, data: n, label,
      x: cx + Math.cos(angle) * spread * (0.3 + Math.random() * 0.7),
      y: cy + Math.sin(angle) * spread * (0.3 + Math.random() * 0.7),
      vx: 0, vy: 0, radius, pinned: false
    };
  });

  graphViz.edges = [];
  for (const e of allEdges) {
    if (idSet.has(e.source) && idSet.has(e.target)) {
      const si = graphViz.nodeMap[e.source];
      const ti = graphViz.nodeMap[e.target];
      if (si !== undefined && ti !== undefined) {
        graphViz.edges.push({ sourceIdx: si, targetIdx: ti, type: e.type || 'RELATES_TO' });
      }
    }
  }

  graphViz.temperature = 1;
}

function simTick() {
  if (graphViz.temperature < 0.01) return;
  const nodes = graphViz.nodes;
  const n = nodes.length;
  if (n === 0) return;

  // Repulsion (all pairs)
  for (let i = 0; i < n; i++) {
    for (let j = i + 1; j < n; j++) {
      let dx = nodes[j].x - nodes[i].x;
      let dy = nodes[j].y - nodes[i].y;
      let dist = Math.sqrt(dx * dx + dy * dy) || 1;
      const force = 5000 / (dist * dist);
      const fx = (dx / dist) * force;
      const fy = (dy / dist) * force;
      if (!nodes[i].pinned) { nodes[i].vx -= fx; nodes[i].vy -= fy; }
      if (!nodes[j].pinned) { nodes[j].vx += fx; nodes[j].vy += fy; }
    }
  }

  // Attraction (edges)
  for (const e of graphViz.edges) {
    const a = nodes[e.sourceIdx], b = nodes[e.targetIdx];
    let dx = b.x - a.x, dy = b.y - a.y;
    let dist = Math.sqrt(dx * dx + dy * dy) || 1;
    const force = 0.005 * (dist - 120);
    const fx = (dx / dist) * force;
    const fy = (dy / dist) * force;
    if (!a.pinned) { a.vx += fx; a.vy += fy; }
    if (!b.pinned) { b.vx -= fx; b.vy -= fy; }
  }

  // Center gravity
  const canvas = $('#graph-canvas');
  const cx = (canvas.width / devicePixelRatio) / 2;
  const cy = (canvas.height / devicePixelRatio) / 2;
  for (const node of nodes) {
    if (node.pinned) continue;
    const dx = cx - node.x, dy = cy - node.y;
    const dist = Math.sqrt(dx * dx + dy * dy) || 1;
    node.vx += dx * 0.001;
    node.vy += dy * 0.001;
    node.vx *= 0.9;
    node.vy *= 0.9;
    node.x += node.vx * graphViz.temperature;
    node.y += node.vy * graphViz.temperature;
  }

  graphViz.temperature *= 0.995;
}

function drawGraph() {
  const canvas = $('#graph-canvas');
  const ctx = canvas.getContext('2d');
  const dpr = devicePixelRatio || 1;
  const w = canvas.clientWidth, h = canvas.clientHeight;
  if (canvas.width !== w * dpr || canvas.height !== h * dpr) {
    canvas.width = w * dpr;
    canvas.height = h * dpr;
  }
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.clearRect(0, 0, w, h);

  ctx.save();
  ctx.translate(graphViz.offsetX, graphViz.offsetY);
  ctx.scale(graphViz.zoom, graphViz.zoom);

  const nodes = graphViz.nodes;
  const edges = graphViz.edges;
  const sel = graphViz.selectedNode;
  const selIdx = sel ? graphViz.nodeMap[sel] : -1;
  const searchActive = graphViz.searchActive;
  const matches = graphViz.searchMatches;

  // Edges
  for (const e of edges) {
    const a = nodes[e.sourceIdx], b = nodes[e.targetIdx];
    const isHighlighted = selIdx === e.sourceIdx || selIdx === e.targetIdx;
    ctx.beginPath();
    ctx.moveTo(a.x, a.y);
    ctx.lineTo(b.x, b.y);
    ctx.strokeStyle = isHighlighted ? '#e9456080' : '#2a2a3a';
    ctx.lineWidth = isHighlighted ? 2 : 1;
    ctx.stroke();
    // Edge label when zoomed in
    if (graphViz.zoom > 0.8 && isHighlighted) {
      const mx = (a.x + b.x) / 2, my = (a.y + b.y) / 2;
      ctx.font = '9px ' + getComputedStyle(document.body).getPropertyValue('--sans');
      ctx.fillStyle = '#555566';
      ctx.textAlign = 'center';
      ctx.fillText(e.type, mx, my - 4);
    }
  }

  // Nodes
  for (let i = 0; i < nodes.length; i++) {
    const node = nodes[i];
    const isSelected = node.id === sel;
    const isHovered = node.id === graphViz.hoveredNode;
    const isMatch = !searchActive || matches.has(node.id);
    const color = NODE_COLORS[node.type] || '#888';
    const alpha = searchActive && !isMatch ? 0.15 : 1;

    ctx.globalAlpha = alpha;

    // Glow for search matches
    if (searchActive && isMatch) {
      ctx.beginPath();
      ctx.arc(node.x, node.y, node.radius + 6, 0, Math.PI * 2);
      ctx.fillStyle = color + '30';
      ctx.fill();
    }

    // Selected glow ring
    if (isSelected) {
      ctx.beginPath();
      ctx.arc(node.x, node.y, node.radius + 4, 0, Math.PI * 2);
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    // Node circle
    ctx.beginPath();
    ctx.arc(node.x, node.y, isSelected ? node.radius + 2 : node.radius, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();

    // Labels
    const showLabel = graphViz.zoom > 0.5 || isSelected || isHovered;
    if (showLabel) {
      ctx.font = (isSelected || isHovered ? 'bold ' : '') + '11px ' + getComputedStyle(document.body).getPropertyValue('--sans');
      ctx.textAlign = 'center';
      ctx.fillStyle = '#e0e0e8';
      ctx.fillText(node.label.slice(0, 25), node.x, node.y + node.radius + 14);
    }

    ctx.globalAlpha = 1;
  }

  // Tooltip on hover
  if (graphViz.hoveredNode && !graphViz.dragging) {
    const idx = graphViz.nodeMap[graphViz.hoveredNode];
    if (idx !== undefined) {
      const node = nodes[idx];
      const tip = node.data.name || node.data.summary || node.label;
      const summary = (node.data.summary || node.data.text || '').slice(0, 80);
      const lines = [tip.slice(0, 40)];
      if (summary && summary !== tip) lines.push(summary);

      ctx.font = '12px ' + getComputedStyle(document.body).getPropertyValue('--sans');
      const maxW = Math.max(...lines.map(l => ctx.measureText(l).width));
      const tw = maxW + 16, th = lines.length * 18 + 12;
      const tx = node.x - tw / 2, ty = node.y - node.radius - th - 8;

      ctx.fillStyle = '#1a1a24ee';
      ctx.strokeStyle = '#2a2a3a';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.roundRect(tx, ty, tw, th, 6);
      ctx.fill();
      ctx.stroke();

      ctx.fillStyle = '#e0e0e8';
      ctx.textAlign = 'left';
      lines.forEach((l, li) => {
        ctx.fillStyle = li === 0 ? '#e0e0e8' : '#8888aa';
        ctx.fillText(l, tx + 8, ty + 16 + li * 18);
      });
    }
  }

  ctx.restore();
}

function hitTest(screenX, screenY) {
  const wx = (screenX - graphViz.offsetX) / graphViz.zoom;
  const wy = (screenY - graphViz.offsetY) / graphViz.zoom;
  for (let i = graphViz.nodes.length - 1; i >= 0; i--) {
    const n = graphViz.nodes[i];
    const dx = wx - n.x, dy = wy - n.y;
    if (dx * dx + dy * dy < (n.radius + 4) * (n.radius + 4)) return n;
  }
  return null;
}

function initCanvasEvents() {
  const canvas = $('#graph-canvas');
  if (graphViz.canvasReady) return;
  graphViz.canvasReady = true;

  canvas.addEventListener('mousedown', (e) => {
    const rect = canvas.getBoundingClientRect();
    const sx = e.clientX - rect.left, sy = e.clientY - rect.top;
    const node = hitTest(sx, sy);
    if (node) {
      graphViz.dragging = node;
      node.pinned = true;
      graphViz.temperature = Math.max(graphViz.temperature, 0.3);
      canvas.classList.add('grabbing');
    } else {
      graphViz.panning = true;
      graphViz.panStart = { x: e.clientX - graphViz.offsetX, y: e.clientY - graphViz.offsetY };
      canvas.classList.add('grabbing');
    }
  });

  canvas.addEventListener('mousemove', (e) => {
    const rect = canvas.getBoundingClientRect();
    const sx = e.clientX - rect.left, sy = e.clientY - rect.top;
    if (graphViz.dragging) {
      const wx = (sx - graphViz.offsetX) / graphViz.zoom;
      const wy = (sy - graphViz.offsetY) / graphViz.zoom;
      graphViz.dragging.x = wx;
      graphViz.dragging.y = wy;
      graphViz.dragging.vx = 0;
      graphViz.dragging.vy = 0;
    } else if (graphViz.panning) {
      graphViz.offsetX = e.clientX - graphViz.panStart.x;
      graphViz.offsetY = e.clientY - graphViz.panStart.y;
    } else {
      const node = hitTest(sx, sy);
      graphViz.hoveredNode = node ? node.id : null;
      canvas.classList.toggle('pointer', !!node);
    }
  });

  canvas.addEventListener('mouseup', (e) => {
    if (graphViz.dragging) {
      const wasDrag = graphViz.dragging;
      graphViz.dragging = null;
      // If barely moved, treat as click
      const rect = canvas.getBoundingClientRect();
      const sx = e.clientX - rect.left, sy = e.clientY - rect.top;
      const node = hitTest(sx, sy);
      if (node && node.id === wasDrag.id) {
        selectCanvasNode(node.id);
      }
      wasDrag.pinned = false;
    } else if (graphViz.panning) {
      graphViz.panning = false;
      // Check if it was a click (no movement)
      const rect = canvas.getBoundingClientRect();
      const sx = e.clientX - rect.left, sy = e.clientY - rect.top;
      const node = hitTest(sx, sy);
      if (!node) {
        graphViz.selectedNode = null;
        $('#graph-overlay').classList.remove('open');
      }
    }
    canvas.classList.remove('grabbing');
  });

  canvas.addEventListener('mouseleave', () => {
    graphViz.hoveredNode = null;
    if (graphViz.dragging) {
      graphViz.dragging.pinned = false;
      graphViz.dragging = null;
    }
    graphViz.panning = false;
    canvas.classList.remove('grabbing');
  });

  canvas.addEventListener('wheel', (e) => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    const factor = e.deltaY < 0 ? 1.1 : 0.9;
    const newZoom = Math.max(0.1, Math.min(4, graphViz.zoom * factor));
    // Zoom toward cursor
    graphViz.offsetX = mx - (mx - graphViz.offsetX) * (newZoom / graphViz.zoom);
    graphViz.offsetY = my - (my - graphViz.offsetY) * (newZoom / graphViz.zoom);
    graphViz.zoom = newZoom;
    $('#graph-zoom-label').textContent = Math.round(newZoom * 100) + '%';
  }, { passive: false });
}

async function selectCanvasNode(nodeId) {
  graphViz.selectedNode = nodeId;
  selectedGraphNode = nodeId;
  $$('.graph-result-item').forEach(item => {
    item.classList.toggle('selected', item.dataset.nodeId === nodeId);
  });

  try {
    const data = await api(`graph/node/${encodeURIComponent(nodeId)}`);
    renderDetailOverlay(data);
    $('#graph-overlay').classList.add('open');
  } catch (err) {
    $('#graph-overlay-content').innerHTML = `<div style="color:var(--text-muted);padding:20px;">Error loading node</div>`;
    $('#graph-overlay').classList.add('open');
  }
}

function renderDetailOverlay(node) {
  const rawName = node.name || node.id.split(':')[1] || node.id;
  // Extract a short title: first meaningful line from summary, stripped of markdown
  let title = rawName;
  if (node.summary) {
    const lines = node.summary.split('\n').map(l => l.trim()).filter(l => l && !l.match(/^\*{2}summary\*{2}$/i));
    const first = lines[0] || '';
    const clean = first.replace(/\*\*/g, '').replace(/^[-*]\s*/, '').replace(/^Task:\s*/i, '').trim();
    if (clean.length > 0) title = clean.length > 80 ? clean.slice(0, 80) + '...' : clean;
  }
  const type = node.type || 'unknown';
  const color = NODE_COLORS[type] || '#888';

  let html = `<div class="graph-node-card ${type}">
    <div class="graph-node-header">
      <div>
        <div class="graph-node-id">${escapeHtml(node.id)}</div>
        <div class="graph-node-title">${escapeHtml(title)}</div>
      </div>
      <span class="graph-result-type ${type}">${type}</span>
    </div>`;

  if (node.summary) {
    html += `<div class="graph-node-section">
      <div class="graph-node-section-content">${renderMarkdownLite(node.summary)}</div>
    </div>`;
  }

  if (node.text) {
    html += `<div class="graph-node-section">
      <div class="graph-node-section-title">Content</div>
      <div class="graph-node-section-content">${renderMarkdownLite(node.text)}</div>
    </div>`;
  }

  const metadata = [];
  if (node.mentions) metadata.push(`Mentions: ${node.mentions}`);
  if (node.entityType) metadata.push(`Type: ${node.entityType}`);
  if (node.timestamp) metadata.push(`Date: ${new Date(node.timestamp).toLocaleString()}`);
  if (node.cost) metadata.push(`Cost: $${node.cost.toFixed(4)}`);
  if (node.messageCount) metadata.push(`Messages: ${node.messageCount}`);

  if (metadata.length > 0) {
    html += `<div class="graph-node-section">
      <div class="graph-node-section-title">Metadata</div>
      <div class="graph-node-section-content">${metadata.join(' &bull; ')}</div>
    </div>`;
  }

  if (node.neighbors && node.neighbors.length > 0) {
    // Group by edge type
    const grouped = {};
    for (const neighbor of node.neighbors) {
      const edgeType = (node.edges || []).find(e => e.target === neighbor.id || e.source === neighbor.id)?.type || 'RELATES_TO';
      if (!grouped[edgeType]) grouped[edgeType] = [];
      grouped[edgeType].push(neighbor);
    }

    html += `<div class="graph-node-section">
      <div class="graph-node-section-title">Connected Nodes (${node.neighbors.length})</div>`;

    for (const [edgeType, neighbors] of Object.entries(grouped)) {
      html += `<div style="margin-bottom:8px;">
        <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase;">${escapeHtml(edgeType)}</div>
        <div style="display:flex;flex-wrap:wrap;">`;
      for (const nb of neighbors.slice(0, 15)) {
        const nbName = nb.name || nb.summary || nb.id.split(':')[1] || nb.id;
        const nbColor = NODE_COLORS[nb.type] || '#888';
        html += `<span class="graph-chip" onclick="selectCanvasNode('${escapeHtml(nb.id)}')">
          <span class="graph-chip-dot" style="background:${nbColor}"></span>
          ${escapeHtml(nbName.slice(0, 30))}
        </span>`;
      }
      html += `</div></div>`;
    }
    html += `</div>`;
  }

  if (node.edges && node.edges.length > 0) {
    html += `<div class="graph-node-section">
      <div class="graph-node-section-title">Relationships</div>
      <div class="graph-node-section-content">`;
    for (const edge of node.edges.slice(0, 10)) {
      const target = edge.target || edge.source;
      const edgeType = edge.type || 'RELATES_TO';
      html += `<div style="margin-bottom:4px;">${escapeHtml(edgeType)} &rarr; ${escapeHtml(target)}</div>`;
    }
    html += `</div></div>`;
  }

  html += `</div>`;
  $('#graph-overlay-content').innerHTML = html;
}

function centerView() {
  if (graphViz.nodes.length === 0) return;
  const canvas = $('#graph-canvas');
  const w = canvas.clientWidth, h = canvas.clientHeight;
  let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
  for (const n of graphViz.nodes) {
    minX = Math.min(minX, n.x - n.radius);
    maxX = Math.max(maxX, n.x + n.radius);
    minY = Math.min(minY, n.y - n.radius);
    maxY = Math.max(maxY, n.y + n.radius);
  }
  const gw = maxX - minX + 80, gh = maxY - minY + 80;
  const zoom = Math.min(1.5, w / gw, h / gh);
  const cx = (minX + maxX) / 2, cy = (minY + maxY) / 2;
  graphViz.zoom = zoom;
  graphViz.offsetX = w / 2 - cx * zoom;
  graphViz.offsetY = h / 2 - cy * zoom;
  $('#graph-zoom-label').textContent = Math.round(zoom * 100) + '%';
}

function startGraphLoop() {
  if (graphViz.animFrame) cancelAnimationFrame(graphViz.animFrame);
  function loop() {
    simTick();
    drawGraph();
    if (graphViz.temperature >= 0.01 || graphViz.dragging || graphViz.panning) {
      graphViz.animFrame = requestAnimationFrame(loop);
    } else {
      drawGraph(); // Final frame
      graphViz.animFrame = null;
    }
  }
  graphViz.animFrame = requestAnimationFrame(loop);
}

async function loadGraphView() {
  try {
    const [graphData, stats] = await Promise.all([api('graph'), api('graph/stats').catch(() => null)]);
    if (stats) {
      $('#stat-nodes').textContent = stats.totalNodes || 0;
      $('#stat-edges').textContent = stats.totalEdges || 0;
    }

    buildGraphData(graphData);

    // Populate sidebar results
    const allNodes = (graphData.nodes || []).filter(n => graphTypeFilters[n.type] !== false);
    renderGraphResults(allNodes.slice(0, 50));

    initCanvasEvents();

    // Defer layout to ensure canvas has size
    requestAnimationFrame(() => {
      centerView();
      graphViz.temperature = 1;
      startGraphLoop();
    });
  } catch (err) {
    console.error('Failed to load graph:', err);
    $('#graph-results-list').innerHTML = '<div style="padding:12px;color:var(--text-muted);">Error loading graph</div>';
  }
}

async function loadGraphSearch(query) {
  const resultsList = $('#graph-results-list');
  if (!query.trim()) {
    graphViz.searchActive = false;
    graphViz.searchMatches.clear();
    if (graphViz.rawData) {
      const nodes = (graphViz.rawData.nodes || []).filter(n => graphTypeFilters[n.type] !== false);
      renderGraphResults(nodes.slice(0, 50));
    }
    if (graphViz.animFrame === null && graphViz.nodes.length > 0) drawGraph();
    return;
  }

  try {
    const data = await api(`graph/search?q=${encodeURIComponent(query)}`);
    const results = (data.results || []).filter(r => graphTypeFilters[r.type] !== false);
    renderGraphResults(results);

    graphViz.searchActive = true;
    graphViz.searchMatches.clear();
    for (const r of results) graphViz.searchMatches.add(r.id);

    if (graphViz.animFrame === null && graphViz.nodes.length > 0) drawGraph();
  } catch (err) {
    resultsList.innerHTML = '<div style="padding:12px;color:var(--text-muted);">Search failed</div>';
  }
}

function renderGraphResults(results) {
  const resultsList = $('#graph-results-list');
  if (results.length === 0) {
    resultsList.innerHTML = '<div style="padding:12px;color:var(--text-muted);">No results</div>';
    return;
  }

  resultsList.innerHTML = results.map(r => {
    const name = r.name || r.summary || r.text || r.id.split(':')[1] || r.id;
    const type = r.type || 'unknown';
    const meta = [];
    if (r.mentions) meta.push(`${r.mentions} mentions`);
    if (r.entityType) meta.push(r.entityType);
    if (r.timestamp) meta.push(new Date(r.timestamp).toLocaleDateString());

    return `
      <div class="graph-result-item" data-node-id="${escapeHtml(r.id)}" onclick="selectGraphNode('${escapeHtml(r.id)}')">
        <div class="graph-result-id">${escapeHtml(r.id)}</div>
        <div class="graph-result-name">${escapeHtml(name.slice(0, 60))}${name.length > 60 ? '...' : ''}</div>
        <div>
          <span class="graph-result-type ${type}">${type}</span>
          ${meta.length > 0 ? `<span class="graph-result-meta">${meta.join(' &bull; ')}</span>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

async function selectGraphNode(nodeId) {
  selectedGraphNode = nodeId;
  $$('.graph-result-item').forEach(item => {
    item.classList.toggle('selected', item.dataset.nodeId === nodeId);
  });
  selectCanvasNode(nodeId);
}

// Graph search handlers
$('#graph-search-btn').addEventListener('click', () => {
  const query = $('#graph-search-input').value.trim();
  loadGraphSearch(query);
});

$('#graph-search-input').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    $('#graph-search-btn').click();
  }
});

// Type filter handlers
$$('.graph-filter-checkbox input').forEach(checkbox => {
  checkbox.addEventListener('change', () => {
    graphTypeFilters[checkbox.dataset.type] = checkbox.checked;
    if (graphViz.rawData) {
      buildGraphData(graphViz.rawData);
      const nodes = (graphViz.rawData.nodes || []).filter(n => graphTypeFilters[n.type] !== false);
      renderGraphResults(nodes.slice(0, 50));
      centerView();
      graphViz.temperature = 0.5;
      startGraphLoop();
    }
  });
});

// Toolbar handlers
$('#graph-reload-btn').addEventListener('click', async () => {
  await api('graph/reload', { method: 'POST' });
  await loadGraphView();
  toast('Graph reloaded');
});
$('#graph-center-btn').addEventListener('click', () => { centerView(); drawGraph(); });
$('#graph-zoom-in').addEventListener('click', () => {
  graphViz.zoom = Math.min(4, graphViz.zoom * 1.3);
  $('#graph-zoom-label').textContent = Math.round(graphViz.zoom * 100) + '%';
  drawGraph();
});
$('#graph-zoom-out').addEventListener('click', () => {
  graphViz.zoom = Math.max(0.1, graphViz.zoom / 1.3);
  $('#graph-zoom-label').textContent = Math.round(graphViz.zoom * 100) + '%';
  drawGraph();
});
$('#graph-overlay-close').addEventListener('click', () => {
  graphViz.selectedNode = null;
  selectedGraphNode = null;
  $$('.graph-result-item').forEach(item => item.classList.remove('selected'));
  $('#graph-overlay').classList.remove('open');
  drawGraph();
});

// ═══════ SETTINGS VIEW ═══════

let currentSettingsSection = 'general';

$$('.settings-pill').forEach(pill => {
  pill.addEventListener('click', () => {
    currentSettingsSection = pill.dataset.section;
    $$('.settings-pill').forEach(p => p.classList.toggle('active', p.dataset.section === currentSettingsSection));
    $$('.settings-section').forEach(s => s.classList.toggle('active', s.id === `settings-${currentSettingsSection}`));
    loadSettingsSection();
  });
});

async function loadSettingsSection() {
  const s = currentSettingsSection;
  if (s === 'general') loadConfig();
  else if (s === 'models') loadModels();
  else if (s === 'credentials') loadCredentials();
  else if (s === 'channels') loadChannels();
  else if (s === 'gateway') loadGatewaySettings();
  else if (s === 'crons') loadCrons();
  else if (s === 'skills') loadSkills();
  else if (s === 'tools') loadTools();
}

// --- General Config ---
const MODEL_ROLES = ['router', 'quick', 'default', 'deep'];
const PROVIDERS = ['anthropic', 'ollama', 'openai', 'openrouter', 'together', 'groq', 'pollinations', 'generic'];

// Model cache — fetched live from provider APIs
const _modelCache = {};

async function fetchModelsForProvider(provider) {
  if (_modelCache[provider]) return _modelCache[provider];
  try {
    const models = await api(`models/${provider}`);
    _modelCache[provider] = models;
    return models;
  } catch {
    return [];
  }
}

const PROVIDER_CRED = {
  anthropic: 'anthropic_api_key',
  openai: 'openai_api_key',
  openrouter: 'openrouter_api_key',
  together: 'together_api_key',
  groq: 'groq_api_key',
  pollinations: null,
  ollama: null,
  generic: null,
};

async function loadConfig() {
  const data = await api('config');
  const c = data.current;
  $('#cfg-vault').value = c.vault || '';
  $('#cfg-dailyNotesDir').value = c.dailyNotesDir || '';
  $('#cfg-inboxDir').value = c.inboxDir || '';
  $('#cfg-keepRecent').value = c.compaction?.keepRecentMessages ?? '';
  $('#cfg-maxCompact').value = c.compaction?.maxMessagesBeforeCompact ?? '';
  $('#cfg-dailyLimit').value = c.budget?.dailyLimit ?? '';
  $('#cfg-warnAt').value = c.budget?.warnAt ?? '';
}

$('#config-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const body = {};
  const vault = $('#cfg-vault').value.trim();
  if (vault) body.vault = vault;
  const dailyNotesDir = $('#cfg-dailyNotesDir').value.trim();
  if (dailyNotesDir) body.dailyNotesDir = dailyNotesDir;
  const inboxDir = $('#cfg-inboxDir').value.trim();
  if (inboxDir) body.inboxDir = inboxDir;
  body.compaction = {
    keepRecentMessages: parseInt($('#cfg-keepRecent').value) || 10,
    maxMessagesBeforeCompact: parseInt($('#cfg-maxCompact').value) || 30,
  };
  body.budget = {
    dailyLimit: parseFloat($('#cfg-dailyLimit').value) || 2.0,
    warnAt: parseFloat($('#cfg-warnAt').value) || 1.5,
  };
  await api('config', { method: 'POST', body });
  toast('Config saved');
});

// --- Models ---
let _modelsCreds = [];

function getKeyBadge(provider) {
  const credKey = PROVIDER_CRED[provider];
  if (!credKey) return '<span class="badge ok" style="font-size:11px;">No key needed</span>';
  const cred = _modelsCreds.find(c => c.name === credKey);
  if (cred?.configured) return '<span class="badge ok" style="font-size:11px;">Key set</span>';
  return `<button class="btn sm danger model-set-key-btn" data-cred="${credKey}" style="font-size:11px;">Set Key</button>`;
}

async function populateModelPicker(role, provider, currentModel) {
  const picker = $(`.model-picker[data-role="${role}"]`);
  const input = picker.querySelector('.model-search');
  const list = picker.querySelector('.model-list');
  const selected = picker.querySelector('.model-selected');

  input.value = '';
  list.innerHTML = '<div style="color:var(--text-dim);padding:8px;">Loading...</div>';

  const models = await fetchModelsForProvider(provider);

  // Set the displayed selected value
  if (currentModel) {
    const match = models.find(m => m.id === currentModel);
    selected.textContent = match ? match.name : currentModel;
    selected.dataset.modelId = currentModel;
  } else {
    selected.textContent = 'Select a model...';
    selected.dataset.modelId = '';
  }

  function renderList(filter = '') {
    const q = filter.toLowerCase();
    const filtered = q
      ? models.filter(m => m.id.toLowerCase().includes(q) || m.name.toLowerCase().includes(q))
      : models;
    const show = filtered.slice(0, 50);
    list.innerHTML = show.map(m =>
      `<div class="model-option${m.id === selected.dataset.modelId ? ' active' : ''}" data-id="${escapeHtml(m.id)}">
        <span class="model-option-name">${escapeHtml(m.name)}</span>
        <span class="model-option-id">${escapeHtml(m.id)}</span>
      </div>`
    ).join('');
    if (filtered.length > 50) {
      list.innerHTML += `<div style="color:var(--text-dim);padding:6px 8px;font-size:11px;">${filtered.length - 50} more — type to filter</div>`;
    }
    if (!show.length) {
      list.innerHTML = `<div style="color:var(--text-dim);padding:8px;">No matches. Use this ID directly?
        <button class="btn sm model-use-custom" data-id="${escapeHtml(filter)}" style="margin-left:8px;">Use "${escapeHtml(filter)}"</button></div>`;
    }
    // Bind clicks
    list.querySelectorAll('.model-option').forEach(opt => {
      opt.addEventListener('click', () => {
        selected.textContent = opt.querySelector('.model-option-name').textContent;
        selected.dataset.modelId = opt.dataset.id;
        picker.classList.remove('open');
        input.value = '';
      });
    });
    list.querySelectorAll('.model-use-custom').forEach(btn => {
      btn.addEventListener('click', () => {
        selected.textContent = btn.dataset.id;
        selected.dataset.modelId = btn.dataset.id;
        picker.classList.remove('open');
        input.value = '';
      });
    });
  }

  renderList();
  input.addEventListener('input', () => renderList(input.value));
}

async function loadModels() {
  const [data, creds] = await Promise.all([api('config'), api('creds')]);
  _modelsCreds = creds;
  const c = data.current;
  const container = $('#cfg-models');
  container.innerHTML = '';

  for (const role of MODEL_ROLES) {
    const m = c.models?.[role] || {};
    const provider = m.provider || 'openrouter';
    const model = m.model || '';

    const row = document.createElement('div');
    row.className = 'model-role-row';
    row.innerHTML = `
      <div class="model-role-header">
        <label>${role}</label>
        <span class="model-key-badge" data-role="${role}">${getKeyBadge(provider)}</span>
      </div>
      <div class="model-role-controls">
        <select data-role="${role}" data-field="provider" class="model-provider-select">
          ${PROVIDERS.map(p => `<option value="${p}" ${p === provider ? 'selected' : ''}>${p}</option>`).join('')}
        </select>
        <div class="model-picker" data-role="${role}">
          <div class="model-selected" data-model-id="">Select a model...</div>
          <div class="model-dropdown">
            <input type="text" class="model-search" placeholder="Search models...">
            <div class="model-list"></div>
          </div>
        </div>
      </div>
      <div class="model-key-input" data-role="${role}"></div>
    `;
    container.appendChild(row);
  }

  // Open/close model pickers
  $$('.model-selected').forEach(sel => {
    sel.addEventListener('click', (e) => {
      e.stopPropagation();
      const picker = sel.closest('.model-picker');
      const wasOpen = picker.classList.contains('open');
      $$('.model-picker').forEach(p => p.classList.remove('open'));
      if (!wasOpen) {
        picker.classList.add('open');
        picker.querySelector('.model-search').focus();
      }
    });
  });

  // Close pickers on outside click
  document.addEventListener('click', () => $$('.model-picker').forEach(p => p.classList.remove('open')));
  $$('.model-dropdown').forEach(dd => dd.addEventListener('click', e => e.stopPropagation()));

  // Load models for each role's current provider
  for (const role of MODEL_ROLES) {
    const m = c.models?.[role] || {};
    await populateModelPicker(role, m.provider || 'openrouter', m.model || '');
  }

  // Provider change → refetch models + update key badge
  $$('.model-provider-select').forEach(sel => {
    sel.addEventListener('change', async () => {
      const role = sel.dataset.role;
      const provider = sel.value;
      delete _modelCache[provider]; // force refetch with potentially new key
      $(`.model-key-badge[data-role="${role}"]`).innerHTML = getKeyBadge(provider);
      await populateModelPicker(role, provider, '');
      bindModelKeyButtons();
    });
  });

  bindModelKeyButtons();
}

function bindModelKeyButtons() {
  $$('.model-set-key-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const credName = btn.dataset.cred;
      const role = btn.closest('.model-role-row').querySelector('.model-provider-select').dataset.role;
      const keyDiv = $(`.model-key-input[data-role="${role}"]`);
      if (keyDiv.classList.contains('show')) {
        keyDiv.classList.remove('show');
        keyDiv.innerHTML = '';
        return;
      }
      keyDiv.innerHTML = `
        <div style="display:flex;gap:8px;align-items:center;">
          <input type="password" placeholder="${credName}" class="model-key-val" style="flex:1;">
          <button class="btn sm model-key-save-btn" data-cred="${credName}" data-role="${role}">Save</button>
        </div>
      `;
      keyDiv.classList.add('show');
      keyDiv.querySelector('input').focus();
      keyDiv.querySelector('.model-key-save-btn').addEventListener('click', async () => {
        const val = keyDiv.querySelector('.model-key-val').value;
        if (!val) return;
        await api(`creds/${credName}`, { method: 'POST', body: { value: val } });
        toast(`Saved: ${credName}`);
        keyDiv.classList.remove('show');
        keyDiv.innerHTML = '';
        // Clear model cache so refetch uses new key
        delete _modelCache[$(`select[data-role="${role}"][data-field="provider"]`).value];
        loadModels();
      });
    });
  });
}

$('#models-save').addEventListener('click', async () => {
  const models = {};
  for (const role of MODEL_ROLES) {
    const provider = $(`select[data-role="${role}"][data-field="provider"]`).value;
    const picker = $(`.model-picker[data-role="${role}"]`);
    const model = picker.querySelector('.model-selected').dataset.modelId || '';
    models[role] = { provider, model };
  }
  await api('config', { method: 'POST', body: { models } });
  toast('Models saved');
});

// --- Credentials ---
async function loadCredentials() {
  const creds = await api('creds');
  const tbody = $('#cred-tbody');
  tbody.innerHTML = '';
  for (const c of creds) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-family:var(--mono);font-size:12px;">${escapeHtml(c.name)}</td>
      <td><span class="badge ${c.configured ? 'ok' : 'no'}">${c.configured ? 'Set' : 'Not Set'}</span></td>
      <td>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="btn sm secondary cred-set-btn" data-name="${c.name}">Set</button>
          ${c.configured ? `<button class="btn sm danger cred-rm-btn" data-name="${c.name}">Remove</button>` : ''}
        </div>
        <div class="cred-input" id="cred-input-${c.name}">
          <input type="password" placeholder="Enter value..." id="cred-val-${c.name}">
          <button class="btn sm cred-save-btn" data-name="${c.name}">Save</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  }

  $$('.cred-set-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const input = $(`#cred-input-${btn.dataset.name}`);
      input.classList.toggle('show');
      if (input.classList.contains('show')) input.querySelector('input').focus();
    });
  });

  $$('.cred-save-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const name = btn.dataset.name;
      const value = $(`#cred-val-${name}`).value;
      if (!value) return;
      await api(`creds/${name}`, { method: 'POST', body: { value } });
      toast(`Saved: ${name}`);
      loadCredentials();
    });
  });

  $$('.cred-rm-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      await api(`creds/${btn.dataset.name}`, { method: 'DELETE' });
      toast(`Removed: ${btn.dataset.name}`);
      loadCredentials();
    });
  });
}

// --- Channels ---
const CHANNELS = {
  telegram: {
    label: 'Telegram',
    creds: [
      { key: 'telegram_bot_token', label: 'Bot Token' },
      { key: 'telegram_chat_id', label: 'Chat ID' },
    ],
  },
  slack: {
    label: 'Slack',
    creds: [
      { key: 'slack_bot_token', label: 'Bot Token' },
    ],
  },
};

async function loadChannels() {
  const [creds, gw, cfg] = await Promise.all([api('creds'), api('gateway'), api('config')]);
  const currentDefault = cfg.current?.notifyChannel || 'telegram';

  // Default channel dropdown
  const defSel = $('#ch-default');
  defSel.innerHTML = Object.keys(CHANNELS).map(ch =>
    `<option value="${ch}" ${ch === currentDefault ? 'selected' : ''}>${CHANNELS[ch].label}</option>`
  ).join('');

  const container = $('#ch-cards');
  container.innerHTML = '';

  for (const [chName, chInfo] of Object.entries(CHANNELS)) {
    const card = document.createElement('div');
    card.className = 'channel-card';

    // Credential rows
    let credRows = '';
    for (const c of chInfo.creds) {
      const cred = creds.find(x => x.name === c.key);
      const isSet = cred?.configured;
      credRows += `
        <div class="channel-row">
          <label>${c.label}</label>
          <span class="badge ${isSet ? 'ok' : 'no'}">${isSet ? 'Set' : 'Not Set'}</span>
          <button class="btn sm secondary ch-set-btn" data-cred="${c.key}" data-channel="${chName}">Set</button>
          ${isSet ? `<button class="btn sm danger ch-rm-btn" data-cred="${c.key}" data-channel="${chName}">Remove</button>` : ''}
        </div>
        <div class="cred-input" id="ch-input-${c.key}">
          <input type="password" placeholder="Enter ${c.label}..." id="ch-val-${c.key}">
          <button class="btn sm ch-save-btn" data-cred="${c.key}">Save</button>
        </div>
      `;
    }

    // Slack-specific config
    let configRows = '';
    if (chName === 'slack') {
      const slackChannel = cfg.current?.slack?.channel || '#notifications';
      configRows = `
        <div class="channel-row">
          <label>Channel</label>
          <input type="text" id="ch-slack-channel" value="${escapeHtml(slackChannel)}" style="width:160px;">
          <button class="btn sm" id="ch-slack-channel-save">Save</button>
        </div>
      `;
    }

    // Status
    let statusHtml = '';
    if (chName === 'telegram') {
      const tgConnected = gw.telegram?.connected ?? gw.telegram;
      const botName = gw.telegram?.botName || null;
      if (tgConnected) {
        statusHtml = `<span class="badge ok">Connected</span> polling active${botName ? ` \u00b7 ${escapeHtml(botName)}` : ''}`;
      } else {
        const hasCreds = chInfo.creds.every(c => creds.find(x => x.name === c.key)?.configured);
        statusHtml = hasCreds
          ? '<span class="badge no">Disconnected</span> gateway not running or bot not started'
          : '<span class="badge no">Not Configured</span> set credentials above';
      }
    } else if (chName === 'slack') {
      const hasCreds = chInfo.creds.every(c => creds.find(x => x.name === c.key)?.configured);
      statusHtml = hasCreds
        ? '<span class="badge ok">Configured</span>'
        : '<span class="badge no">Not Configured</span> set credentials above';
    }

    card.innerHTML = `
      <h4>${chInfo.label}</h4>
      ${credRows}
      ${configRows}
      <div class="channel-status">${statusHtml}</div>
      <button class="btn sm secondary ch-test-btn" data-channel="${chName}" style="margin-top:10px;">Test Message</button>
    `;
    container.appendChild(card);
  }

  // Bind credential set/remove/save
  $$('.ch-set-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const input = $(`#ch-input-${btn.dataset.cred}`);
      input.classList.toggle('show');
      if (input.classList.contains('show')) input.querySelector('input').focus();
    });
  });

  $$('.ch-save-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const key = btn.dataset.cred;
      const val = $(`#ch-val-${key}`).value;
      if (!val) return;
      await api(`creds/${key}`, { method: 'POST', body: { value: val } });
      toast(`Saved: ${key}`);
      loadChannels();
    });
  });

  $$('.ch-rm-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      await api(`creds/${btn.dataset.cred}`, { method: 'DELETE' });
      toast(`Removed: ${btn.dataset.cred}`);
      loadChannels();
    });
  });

  // Slack channel save
  const slackSaveBtn = $('#ch-slack-channel-save');
  if (slackSaveBtn) {
    slackSaveBtn.addEventListener('click', async () => {
      const channel = $('#ch-slack-channel').value.trim();
      await api('config', { method: 'POST', body: { slack: { channel } } });
      toast('Slack channel saved');
    });
  }

  // Test buttons
  $$('.ch-test-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      btn.disabled = true;
      btn.textContent = 'Sending...';
      try {
        await api('channels/test', { method: 'POST', body: { channel: btn.dataset.channel } });
        toast('Test message sent!');
      } catch (err) {
        toast(`Failed: ${err.message}`);
      }
      btn.disabled = false;
      btn.textContent = 'Test Message';
    });
  });
}

$('#ch-default-save').addEventListener('click', async () => {
  const channel = $('#ch-default').value;
  await api('config', { method: 'POST', body: { notifyChannel: channel } });
  toast('Default channel saved');
});

// --- Gateway Settings ---
async function loadGatewaySettings() {
  const [gw, cfg] = await Promise.all([api('gateway'), api('config')]);
  const gwDiv = $('#gw-status');

  if (gw.running) {
    const upSec = gw.uptime || 0;
    const upStr = upSec > 3600 ? `${Math.floor(upSec/3600)}h ${Math.floor((upSec%3600)/60)}m` : `${Math.floor(upSec/60)}m`;
    const cronInfo = gw.crons ? ` \u00b7 Crons: ${gw.crons.enabled}/${gw.crons.total} active` : '';
    gwDiv.innerHTML = `
      <span class="badge ok">Running</span> PID ${gw.pid} \u00b7 Up ${upStr}<br>
      Heartbeat: every ${gw.heartbeat.intervalMinutes}m \u00b7 ${gw.heartbeat.count} runs${gw.heartbeat.lastRun ? ` \u00b7 last ${new Date(gw.heartbeat.lastRun).toLocaleTimeString()}` : ''}<br>
      Telegram: ${gw.telegram?.connected ? '<span class="badge ok">Connected</span>' : '<span class="badge no">Off</span>'}${cronInfo}
    `;
  } else {
    gwDiv.innerHTML = '<span class="badge no">Not Running</span> \u2014 start with <code style="background:var(--bg);padding:2px 6px;border-radius:3px;font-family:var(--mono);">betterbot gateway</code>';
  }

  const hb = cfg.current?.heartbeat || {};
  $('#hb-interval').value = hb.intervalMinutes || 15;
  const sources = hb.sources || ['inbox', 'tasks', 'github'];
  $('#hb-src-inbox').checked = sources.includes('inbox');
  $('#hb-src-tasks').checked = sources.includes('tasks');
  $('#hb-src-github').checked = sources.includes('github');
  $('#hb-proactive').checked = hb.proactive !== false;
}

$('#hb-save').addEventListener('click', async () => {
  const intervalMinutes = parseInt($('#hb-interval').value) || 15;
  const sources = [];
  if ($('#hb-src-inbox').checked) sources.push('inbox');
  if ($('#hb-src-tasks').checked) sources.push('tasks');
  if ($('#hb-src-github').checked) sources.push('github');
  const proactive = $('#hb-proactive').checked;
  await api('config', { method: 'POST', body: { heartbeat: { intervalMinutes, sources, proactive } } });
  toast('Heartbeat settings saved');
  loadGatewaySettings();
});

$('#hb-run').addEventListener('click', async () => {
  const box = $('#hb-result');
  box.textContent = 'Running heartbeat...';
  box.classList.add('show');
  try {
    const result = await api('heartbeat/run', { method: 'POST' });
    box.textContent = JSON.stringify(result, null, 2);
  } catch (err) {
    box.textContent = `Error: ${err.message}`;
  }
});

$('#doctor-run').addEventListener('click', async () => {
  const box = $('#doctor-result');
  box.textContent = 'Running doctor...';
  box.classList.add('show');
  try {
    const result = await api('doctor', { method: 'POST' });
    const lines = [];
    for (const msg of result.fixed) lines.push(`FIXED: ${msg}`);
    for (const msg of result.warnings) lines.push(`WARN: ${msg}`);
    for (const msg of result.ok) lines.push(`OK: ${msg}`);
    box.textContent = lines.length > 0 ? lines.join('\n') : 'All checks passed.';
  } catch (err) {
    box.textContent = `Error: ${err.message}`;
  }
});

// --- Crons ---
async function loadCrons() {
  const crons = await api('crons');
  const div = $('#crons-list');
  if (crons.length === 0) {
    div.innerHTML = '<div class="settings-list-empty">No cron jobs. The agent can create them with create_cron.</div>';
    return;
  }
  div.innerHTML = crons.map(c => {
    const status = c.enabled ? '<span class="badge ok">On</span>' : '<span class="badge no">Off</span>';
    const last = c.lastRun ? `last: ${new Date(c.lastRun).toLocaleString()}` : 'never run';
    return `<div class="settings-list-item">
      ${status} <strong>${escapeHtml(c.name)}</strong>
      <span style="color:var(--text-muted);font-family:var(--mono);font-size:12px;margin-left:8px;">${escapeHtml(c.schedule)}</span><br>
      <span style="color:var(--text-dim);font-size:12px;">${escapeHtml(c.prompt.slice(0, 100))}${c.prompt.length > 100 ? '...' : ''}</span><br>
      <span style="color:var(--text-muted);font-size:11px;">${last} \u00b7 ${c.runCount || 0} runs \u00b7 ID: ${c.id}</span>
    </div>`;
  }).join('');
}

// --- Skills ---
async function loadSkills() {
  const skills = await api('skills');
  const div = $('#skills-list');
  if (skills.length === 0) {
    div.innerHTML = '<div class="settings-list-empty">No skills yet. The agent can create them.</div>';
    return;
  }
  div.innerHTML = skills.map(s =>
    `<div class="settings-list-item"><strong>${escapeHtml(s.name)}</strong> <span style="color:var(--text-dim);">\u2014 ${escapeHtml(s.description || 'no description')}</span></div>`
  ).join('');
}

// --- Tools ---
async function loadTools() {
  const tools = await api('custom-tools');
  const div = $('#tools-list');
  if (tools.length === 0) {
    div.innerHTML = '<div class="settings-list-empty">No custom tools yet. The agent can create them.</div>';
    return;
  }
  div.innerHTML = tools.map(t =>
    `<div class="settings-list-item"><strong>${escapeHtml(t.name)}</strong> <span style="color:var(--text-dim);">\u2014 ${escapeHtml(t.description || '')}</span></div>`
  ).join('');
}

// ═══════ FOLDER BROWSER ═══════

let browseTarget = null;
let browseCurrent = '';

async function openBrowse(inputId, startPath) {
  browseTarget = inputId;
  $('#browse-modal').classList.add('show');
  await loadBrowse(startPath || $(inputId).value || '~');
}

async function loadBrowse(path) {
  const data = await api(`browse?path=${encodeURIComponent(path)}`);
  browseCurrent = data.current;
  $('#browse-path').textContent = data.current;

  const bm = $('#browse-bookmarks');
  bm.innerHTML = '';
  if (data.bookmarks) {
    for (const b of data.bookmarks) {
      const btn = document.createElement('button');
      btn.className = 'btn sm secondary';
      btn.textContent = b.label;
      btn.style.fontSize = '11px';
      btn.addEventListener('click', () => loadBrowse(b.path));
      bm.appendChild(btn);
    }
  }

  const list = $('#browse-list');
  list.innerHTML = '';

  const parent = document.createElement('div');
  parent.className = 'folder-item parent';
  parent.innerHTML = '<span class="icon">..</span> <span>Go up</span>';
  parent.addEventListener('click', () => loadBrowse(data.parent));
  list.appendChild(parent);

  for (const entry of data.entries) {
    const item = document.createElement('div');
    item.className = 'folder-item';
    item.innerHTML = `<span class="icon">/</span> <span>${escapeHtml(entry.name)}</span>`;
    item.addEventListener('click', () => loadBrowse(entry.path));
    list.appendChild(item);
  }
}

$('#browse-select').addEventListener('click', () => {
  if (browseTarget) $(browseTarget).value = browseCurrent;
  $('#browse-modal').classList.remove('show');
});
$('#browse-cancel').addEventListener('click', () => $('#browse-modal').classList.remove('show'));
$('#browse-close').addEventListener('click', () => $('#browse-modal').classList.remove('show'));
$('#cfg-vault-browse').addEventListener('click', () => openBrowse('#cfg-vault'));

// ═══════ INIT ═══════

updateTopBar();
updateTicker();
loadSessionsList();
polls.sessions = setInterval(loadSessionsList, 10000);

// Global: update topbar every 15s, ticker every 3s
setInterval(updateTopBar, 15000);
setInterval(updateTicker, 3000);

</script>
</body>
</html>
